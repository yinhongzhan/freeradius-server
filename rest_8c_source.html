<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>FreeRADIUS: /home/pjm3/freeradius-server/src/modules/rlm_rest/rest.c Source File</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />

<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  
  
  <td style="padding-left: 0.5em;">
   <div id="projectname">FreeRADIUS
   
   </div>
   
  </td>
  
  
  
 </tr>
 </tbody>
</table>
</div>

<!-- Generated by Doxygen 1.7.5 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
  <div id="navrow2" class="tabs2">
    <ul class="tablist">
      <li><a href="files.html"><span>File&#160;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div id="nav-path" class="navpath">
    <ul>
      <li class="navelem"><a class="el" href="dir_6054e169f0f58ec6883eae51771d7f33.html">src</a>      </li>
      <li class="navelem"><a class="el" href="dir_4cc3e6fe4b61867fd806af76a262971e.html">modules</a>      </li>
      <li class="navelem"><a class="el" href="dir_9a6f69099da8e4b2c74a1d96056f8454.html">rlm_rest</a>      </li>
    </ul>
  </div>
</div>
<div class="header">
  <div class="headertitle">
<div class="title">rest.c</div>  </div>
</div>
<div class="contents">
<a href="rest_8c.html">Go to the documentation of this file.</a><div class="fragment"><pre class="fragment"><a name="l00001"></a>00001 
<a name="l00024"></a>00024 <span class="preprocessor">#include &lt;freeradius-devel/ident.h&gt;</span>
<a name="l00025"></a>00025 <a class="code" href="vqp_8c.html#acc35cbb33424ff802287b5221a6d3984">RCSID</a>(<span class="stringliteral">&quot;$Id$&quot;</span>)
<a name="l00026"></a>00026 
<a name="l00027"></a>00027 <span class="preprocessor">#include &lt;assert.h&gt;</span>
<a name="l00028"></a>00028 <span class="preprocessor"></span><span class="preprocessor">#include &lt;ctype.h&gt;</span>
<a name="l00029"></a>00029 <span class="preprocessor">#include &lt;string.h&gt;</span>
<a name="l00030"></a>00030 <span class="preprocessor">#include &lt;time.h&gt;</span>
<a name="l00031"></a>00031 
<a name="l00032"></a>00032 <span class="preprocessor">#include &lt;curl/curl.h&gt;</span>
<a name="l00033"></a>00033 <span class="preprocessor">#include &lt;json/json.h&gt;</span>
<a name="l00034"></a>00034 
<a name="l00035"></a>00035 <span class="preprocessor">#include &lt;freeradius-devel/radiusd.h&gt;</span>
<a name="l00036"></a>00036 <span class="preprocessor">#include &lt;freeradius-devel/libradius.h&gt;</span>
<a name="l00037"></a>00037 <span class="preprocessor">#include &lt;freeradius-devel/connection.h&gt;</span>
<a name="l00038"></a>00038 
<a name="l00039"></a>00039 <span class="preprocessor">#include &quot;<a class="code" href="rest_8h.html" title="Function prototypes datatypes for the REST (HTTP) transport.">rest.h</a>&quot;</span>
<a name="l00040"></a>00040 
<a name="l00048"></a><a class="code" href="rest_8h.html#ab429e4b10850d1e40766e0aa58316c9b">00048</a> <span class="keyword">const</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43">http_body_type_t</a> <a class="code" href="rest_8c.html#ab429e4b10850d1e40766e0aa58316c9b" title="Table of encoder/decoder support.">http_body_type_supported</a>[<a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a78ba0aef6bf4ad4affcf0bdaf0a0b0d6">HTTP_BODY_NUM_ENTRIES</a>] = {
<a name="l00049"></a>00049         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>,  <span class="comment">// HTTP_BODY_UNKOWN</span>
<a name="l00050"></a>00050         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>,  <span class="comment">// HTTP_BODY_UNSUPPORTED</span>
<a name="l00051"></a>00051         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>,  <span class="comment">// HTTP_BODY_INVALID</span>
<a name="l00052"></a>00052         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ac6a5a8af942393478386105b35dc80d5">HTTP_BODY_POST</a>,         <span class="comment">// HTTP_BODY_POST</span>
<a name="l00053"></a>00053         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a68c03dcf546a3349f7cdca9cfec7cb08">HTTP_BODY_JSON</a>,         <span class="comment">// HTTP_BODY_JSON</span>
<a name="l00054"></a>00054         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>,  <span class="comment">// HTTP_BODY_XML</span>
<a name="l00055"></a>00055         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>,  <span class="comment">// HTTP_BODY_YAML</span>
<a name="l00056"></a>00056         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a8a3328b9f8f72b0801e0a36769f74cdb">HTTP_BODY_INVALID</a>,      <span class="comment">// HTTP_BODY_HTML</span>
<a name="l00057"></a>00057         HTTP_BODY_INVALID       <span class="comment">// HTTP_BODY_PLAIN</span>
<a name="l00058"></a>00058 };
<a name="l00059"></a>00059 
<a name="l00060"></a>00060 <span class="comment">/*</span>
<a name="l00061"></a>00061 <span class="comment"> *      Lib CURL doesn&#39;t define symbols for unsupported auth methods</span>
<a name="l00062"></a>00062 <span class="comment"> */</span>
<a name="l00063"></a>00063 <span class="preprocessor">#ifndef CURLOPT_TLSAUTH_SRP</span>
<a name="l00064"></a><a class="code" href="rest_8c.html#a69d79dbb506da186a157096c8cd16a5a">00064</a> <span class="preprocessor"></span><span class="preprocessor">#define CURLOPT_TLSAUTH_SRP     0</span>
<a name="l00065"></a>00065 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00066"></a>00066 <span class="preprocessor"></span><span class="preprocessor">#ifndef CURLAUTH_BASIC</span>
<a name="l00067"></a><a class="code" href="rest_8c.html#a71a1fde704d583a1f5dc57f77f1e957b">00067</a> <span class="preprocessor"></span><span class="preprocessor">#define CURLAUTH_BASIC          0</span>
<a name="l00068"></a>00068 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00069"></a>00069 <span class="preprocessor"></span><span class="preprocessor">#ifndef CURLAUTH_DIGEST</span>
<a name="l00070"></a><a class="code" href="rest_8c.html#ae8273f5a281c589c89d0d3ab2f565a93">00070</a> <span class="preprocessor"></span><span class="preprocessor">#define CURLAUTH_DIGEST         0</span>
<a name="l00071"></a>00071 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00072"></a>00072 <span class="preprocessor"></span><span class="preprocessor">#ifndef CURLAUTH_DIGEST_IE</span>
<a name="l00073"></a><a class="code" href="rest_8c.html#a35dfbbf1be296636005ebb30f70ca4ee">00073</a> <span class="preprocessor"></span><span class="preprocessor">#define CURLAUTH_DIGEST_IE      0</span>
<a name="l00074"></a>00074 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00075"></a>00075 <span class="preprocessor"></span><span class="preprocessor">#ifndef CURLAUTH_GSSNEGOTIATE</span>
<a name="l00076"></a><a class="code" href="rest_8c.html#abd8249802f5605e95c6fedcaf22f9f5c">00076</a> <span class="preprocessor"></span><span class="preprocessor">#define CURLAUTH_GSSNEGOTIATE   0</span>
<a name="l00077"></a>00077 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00078"></a>00078 <span class="preprocessor"></span><span class="preprocessor">#ifndef CURLAUTH_NTLM</span>
<a name="l00079"></a><a class="code" href="rest_8c.html#ab0e8299ededa678028a9e5796b0f77ce">00079</a> <span class="preprocessor"></span><span class="preprocessor">#define CURLAUTH_NTLM           0</span>
<a name="l00080"></a>00080 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00081"></a>00081 <span class="preprocessor"></span><span class="preprocessor">#ifndef CURLAUTH_NTLM_WB</span>
<a name="l00082"></a><a class="code" href="rest_8c.html#abc73006227ef9c2827f26b33d7cbadce">00082</a> <span class="preprocessor"></span><span class="preprocessor">#define CURLAUTH_NTLM_WB        0</span>
<a name="l00083"></a>00083 <span class="preprocessor"></span><span class="preprocessor">#endif</span>
<a name="l00084"></a>00084 <span class="preprocessor"></span>
<a name="l00085"></a><a class="code" href="rest_8h.html#a464926ec2ef2e24d5b7da3691b8398f6">00085</a> <span class="keyword">const</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43">http_body_type_t</a> <a class="code" href="rest_8c.html#a464926ec2ef2e24d5b7da3691b8398f6">http_curl_auth</a>[<a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a449054b7a637c4144ed28f418fa5babd">HTTP_AUTH_NUM_ENTRIES</a>] = {
<a name="l00086"></a>00086         0,                      <span class="comment">// HTTP_AUTH_UNKNOWN</span>
<a name="l00087"></a>00087         0,                      <span class="comment">// HTTP_AUTH_NONE</span>
<a name="l00088"></a>00088         <a class="code" href="rest_8c.html#a69d79dbb506da186a157096c8cd16a5a">CURLOPT_TLSAUTH_SRP</a>,    <span class="comment">// HTTP_AUTH_TLS_SRP</span>
<a name="l00089"></a>00089         <a class="code" href="rest_8c.html#a71a1fde704d583a1f5dc57f77f1e957b">CURLAUTH_BASIC</a>,         <span class="comment">// HTTP_AUTH_BASIC</span>
<a name="l00090"></a>00090         <a class="code" href="rest_8c.html#ae8273f5a281c589c89d0d3ab2f565a93">CURLAUTH_DIGEST</a>,        <span class="comment">// HTTP_AUTH_DIGEST</span>
<a name="l00091"></a>00091         <a class="code" href="rest_8c.html#a35dfbbf1be296636005ebb30f70ca4ee">CURLAUTH_DIGEST_IE</a>,     <span class="comment">// HTTP_AUTH_DIGEST_IE</span>
<a name="l00092"></a>00092         <a class="code" href="rest_8c.html#abd8249802f5605e95c6fedcaf22f9f5c">CURLAUTH_GSSNEGOTIATE</a>,  <span class="comment">// HTTP_AUTH_GSSNEGOTIATE</span>
<a name="l00093"></a>00093         <a class="code" href="rest_8c.html#ab0e8299ededa678028a9e5796b0f77ce">CURLAUTH_NTLM</a>,          <span class="comment">// HTTP_AUTH_NTLM</span>
<a name="l00094"></a>00094         <a class="code" href="rest_8c.html#abc73006227ef9c2827f26b33d7cbadce">CURLAUTH_NTLM_WB</a>,       <span class="comment">// HTTP_AUTH_NTLM_WB</span>
<a name="l00095"></a>00095         CURLAUTH_ANY,           <span class="comment">// HTTP_AUTH_ANY</span>
<a name="l00096"></a>00096         CURLAUTH_ANYSAFE        <span class="comment">// HTTP_AUTH_ANY_SAFE</span>
<a name="l00097"></a>00097 };
<a name="l00098"></a>00098 
<a name="l00099"></a>00099 
<a name="l00110"></a><a class="code" href="rest_8h.html#a8dc21ec6893fd93311316d23e446347b">00110</a> <span class="keyword">const</span> <a class="code" href="structFR__NAME__NUMBER.html">FR_NAME_NUMBER</a> <a class="code" href="rest_8c.html#a8dc21ec6893fd93311316d23e446347b" title="Conversion table for method config values.">http_method_table</a>[] = {
<a name="l00111"></a>00111         { <span class="stringliteral">&quot;GET&quot;</span>,                <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a90754abc55dbb76862fa50abee5af659">HTTP_METHOD_GET</a>         },
<a name="l00112"></a>00112         { <span class="stringliteral">&quot;POST&quot;</span>,               <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a1944682922ac79b2e682312d8f3f71e2">HTTP_METHOD_POST</a>        },
<a name="l00113"></a>00113         { <span class="stringliteral">&quot;PUT&quot;</span>,                <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2af7557927b605c64f35f629b43823b1c9">HTTP_METHOD_PUT</a>         },
<a name="l00114"></a>00114         { <span class="stringliteral">&quot;DELETE&quot;</span>,             <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a761371f7807255b7912afbac2f665ffe">HTTP_METHOD_DELETE</a>      },
<a name="l00115"></a>00115 
<a name="l00116"></a>00116         {  NULL , -1 }
<a name="l00117"></a>00117 };
<a name="l00118"></a>00118 
<a name="l00128"></a><a class="code" href="rest_8c.html#ad34138dc5bcd567ef2c520ef721c8ac2">00128</a> <span class="keyword">const</span> <a class="code" href="structFR__NAME__NUMBER.html">FR_NAME_NUMBER</a> <a class="code" href="rest_8c.html#ad34138dc5bcd567ef2c520ef721c8ac2" title="Conversion table for type config values.">http_body_type_table</a>[] = {
<a name="l00129"></a>00129         { <span class="stringliteral">&quot;unknown&quot;</span>,            <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a4a3674c75efd39582b497441acf04d41">HTTP_BODY_UNKNOWN</a>       },
<a name="l00130"></a>00130         { <span class="stringliteral">&quot;unsupported&quot;</span>,        <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>   },
<a name="l00131"></a>00131         { <span class="stringliteral">&quot;invalid&quot;</span>,            <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a8a3328b9f8f72b0801e0a36769f74cdb">HTTP_BODY_INVALID</a>       },
<a name="l00132"></a>00132         { <span class="stringliteral">&quot;post&quot;</span>,               <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ac6a5a8af942393478386105b35dc80d5">HTTP_BODY_POST</a>          },
<a name="l00133"></a>00133         { <span class="stringliteral">&quot;json&quot;</span>,               <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a68c03dcf546a3349f7cdca9cfec7cb08">HTTP_BODY_JSON</a>          },
<a name="l00134"></a>00134         { <span class="stringliteral">&quot;xml&quot;</span>,                <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ad2e34d9f24861c32ac553b6cea746be1">HTTP_BODY_XML</a>           },
<a name="l00135"></a>00135         { <span class="stringliteral">&quot;yaml&quot;</span>,               <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a9364f084a9c76e1c4669757278c6a33c">HTTP_BODY_YAML</a>          },
<a name="l00136"></a>00136         { <span class="stringliteral">&quot;html&quot;</span>,               <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43acd89b006f022a89db6f604472a71043d">HTTP_BODY_HTML</a>          },
<a name="l00137"></a>00137         { <span class="stringliteral">&quot;plain&quot;</span>,              <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43af18fc16eefbea13657dedc63f8b321a6">HTTP_BODY_PLAIN</a>         },
<a name="l00138"></a>00138 
<a name="l00139"></a>00139         {  NULL , -1 }
<a name="l00140"></a>00140 };
<a name="l00141"></a>00141 
<a name="l00142"></a><a class="code" href="rest_8h.html#ae9d58a7026dcc3f6e7e9a7c608f088cf">00142</a> <span class="keyword">const</span> <a class="code" href="structFR__NAME__NUMBER.html">FR_NAME_NUMBER</a> <a class="code" href="rest_8c.html#ae9d58a7026dcc3f6e7e9a7c608f088cf">http_auth_table</a>[] = {
<a name="l00143"></a>00143         { <span class="stringliteral">&quot;none&quot;</span>,               <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a208f0926853b84d7acf3ce0669e9dc1c">HTTP_AUTH_NONE</a>          },
<a name="l00144"></a>00144         { <span class="stringliteral">&quot;srp&quot;</span>,                <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a752ceaf5e18fd71ccab046068141706c">HTTP_AUTH_TLS_SRP</a>       },
<a name="l00145"></a>00145         { <span class="stringliteral">&quot;basic&quot;</span>,              <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a946b7e60a754342e83205964b31a77ba">HTTP_AUTH_BASIC</a>         },
<a name="l00146"></a>00146         { <span class="stringliteral">&quot;digest&quot;</span>,             <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a2de9030bd220adb7701f5cbdeadfc4a3">HTTP_AUTH_DIGEST</a>        },
<a name="l00147"></a>00147         { <span class="stringliteral">&quot;digest-ie&quot;</span>,          <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a1f0c85c5931f26c607c7e47cf13a2d69">HTTP_AUTH_DIGEST_IE</a>     },
<a name="l00148"></a>00148         { <span class="stringliteral">&quot;gss-negotiate&quot;</span>,      <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a619673a5be376264ae5698ad9709b48a">HTTP_AUTH_GSSNEGOTIATE</a>  },
<a name="l00149"></a>00149         { <span class="stringliteral">&quot;ntlm&quot;</span>,               <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a42fba6486b2a44775f09c0cfb8ac5176">HTTP_AUTH_NTLM</a>          },
<a name="l00150"></a>00150         { <span class="stringliteral">&quot;ntlm-winbind&quot;</span>,       <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a7c399281a3b842ff124c6f916fc82db6">HTTP_AUTH_NTLM_WB</a>       },
<a name="l00151"></a>00151         { <span class="stringliteral">&quot;any&quot;</span>,                <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a4738427f84f848c4e476644bd78a83cc">HTTP_AUTH_ANY</a>           },
<a name="l00152"></a>00152         { <span class="stringliteral">&quot;safe&quot;</span>,               <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5afe11e217d1bdaa3d306d3b679d016414">HTTP_AUTH_ANY_SAFE</a>      },
<a name="l00153"></a>00153 
<a name="l00154"></a>00154         {  NULL , -1 }
<a name="l00155"></a>00155 };
<a name="l00156"></a>00156 
<a name="l00171"></a><a class="code" href="rest_8c.html#a66f9f5e6959f072ef736c9c2bb86b25b">00171</a> <span class="keyword">const</span> <a class="code" href="structFR__NAME__NUMBER.html">FR_NAME_NUMBER</a> <a class="code" href="rest_8c.html#a66f9f5e6959f072ef736c9c2bb86b25b" title="Conversion table for &quot;Content-Type&quot; header values.">http_content_type_table</a>[] = {
<a name="l00172"></a>00172         { <span class="stringliteral">&quot;application/x-www-form-urlencoded&quot;</span>, <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ac6a5a8af942393478386105b35dc80d5">HTTP_BODY_POST</a> },
<a name="l00173"></a>00173         { <span class="stringliteral">&quot;application/json&quot;</span>,   <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a68c03dcf546a3349f7cdca9cfec7cb08">HTTP_BODY_JSON</a>          },
<a name="l00174"></a>00174         { <span class="stringliteral">&quot;text/html&quot;</span>,          <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43acd89b006f022a89db6f604472a71043d">HTTP_BODY_HTML</a>          },
<a name="l00175"></a>00175         { <span class="stringliteral">&quot;text/plain&quot;</span>,         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43af18fc16eefbea13657dedc63f8b321a6">HTTP_BODY_PLAIN</a>         },
<a name="l00176"></a>00176         { <span class="stringliteral">&quot;text/xml&quot;</span>,           <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ad2e34d9f24861c32ac553b6cea746be1">HTTP_BODY_XML</a>           },
<a name="l00177"></a>00177         { <span class="stringliteral">&quot;text/yaml&quot;</span>,          <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a9364f084a9c76e1c4669757278c6a33c">HTTP_BODY_YAML</a>          },
<a name="l00178"></a>00178         { <span class="stringliteral">&quot;text/x-yaml&quot;</span>,        <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a9364f084a9c76e1c4669757278c6a33c">HTTP_BODY_YAML</a>          },
<a name="l00179"></a>00179         { <span class="stringliteral">&quot;application/yaml&quot;</span>,   <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a9364f084a9c76e1c4669757278c6a33c">HTTP_BODY_YAML</a>          },
<a name="l00180"></a>00180         { <span class="stringliteral">&quot;application/x-yaml&quot;</span>, <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a9364f084a9c76e1c4669757278c6a33c">HTTP_BODY_YAML</a>          },
<a name="l00181"></a>00181         {  NULL , -1 }
<a name="l00182"></a>00182 };
<a name="l00183"></a>00183 
<a name="l00193"></a>00193 <span class="keyword">typedef</span> <span class="keyword">struct </span><a class="code" href="structjson__flags.html" title="Flags to control the conversion of JSON values to VALUE_PAIRs.">json_flags</a> {
<a name="l00194"></a><a class="code" href="structjson__flags.html#a9b3a476a79eb7226929258f85b190ade">00194</a>         <span class="keywordtype">boolean</span>  <a class="code" href="structjson__flags.html#a9b3a476a79eb7226929258f85b190ade" title="If TRUE value will be expanded with xlat.">do_xlat</a>;       
<a name="l00195"></a><a class="code" href="structjson__flags.html#aa65e14f7293634b47659ac9b05e7483d">00195</a>         <span class="keywordtype">boolean</span>  <a class="code" href="structjson__flags.html#aa65e14f7293634b47659ac9b05e7483d" title="If TRUE value will be inserted as raw JSON.">is_json</a>;       
<a name="l00196"></a>00196                                 <span class="comment">// (multiple values not supported).</span>
<a name="l00197"></a><a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284">00197</a>         <a class="code" href="token_8h.html#ada515cc388d528d3b2c86f0f3cb60ed3">FR_TOKEN</a> <span class="keyword">operator</span>;      
<a name="l00198"></a>00198                                 <span class="comment">// is processed. @see fr_tokens</span>
<a name="l00199"></a>00199 } <a class="code" href="rest_8c.html#a9625f898b57b0cf16d0af5041e1d37f0" title="Flags to control the conversion of JSON values to VALUE_PAIRs.">json_flags_t</a>;
<a name="l00200"></a>00200 
<a name="l00213"></a><a class="code" href="rest_8h.html#af9d6c0d1b81049f9b15e3eaefeb7f4d3">00213</a> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#af9d6c0d1b81049f9b15e3eaefeb7f4d3" title="Initialises libcurl.">rest_init</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance)
<a name="l00214"></a>00214 {
<a name="l00215"></a>00215         CURLcode ret;
<a name="l00216"></a>00216 
<a name="l00217"></a>00217         ret = curl_global_init(CURL_GLOBAL_ALL);
<a name="l00218"></a>00218         <span class="keywordflow">if</span> (ret != CURLE_OK) {
<a name="l00219"></a>00219                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>,
<a name="l00220"></a>00220                        <span class="stringliteral">&quot;rlm_rest (%s): CURL init returned error: %i - %s&quot;</span>,
<a name="l00221"></a>00221                        instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>,
<a name="l00222"></a>00222                        ret, curl_easy_strerror(ret));
<a name="l00223"></a>00223 
<a name="l00224"></a>00224                 curl_global_cleanup();
<a name="l00225"></a>00225                 <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00226"></a>00226         }
<a name="l00227"></a>00227 
<a name="l00228"></a>00228         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#aa5f53e6fead7ace0a59f8efed49a8a6a">L_DBG</a>, <span class="stringliteral">&quot;rlm_rest (%s): CURL library version: %s&quot;</span>,
<a name="l00229"></a>00229                instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>,
<a name="l00230"></a>00230                curl_version());
<a name="l00231"></a>00231 
<a name="l00232"></a>00232         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00233"></a>00233 }
<a name="l00234"></a>00234 
<a name="l00242"></a><a class="code" href="rest_8h.html#ad7843e88d39eab69006b7d59942e7fa8">00242</a> <span class="keywordtype">void</span> <a class="code" href="rest_8c.html#ad7843e88d39eab69006b7d59942e7fa8" title="Cleans up after libcurl.">rest_cleanup</a>(<span class="keywordtype">void</span>)
<a name="l00243"></a>00243 {
<a name="l00244"></a>00244         curl_global_cleanup();
<a name="l00245"></a>00245 }
<a name="l00246"></a>00246 
<a name="l00271"></a><a class="code" href="rest_8h.html#a42b9e597858032b32706c7e6d9b730b4">00271</a> <span class="keywordtype">void</span> *<a class="code" href="rest_8c.html#a42b9e597858032b32706c7e6d9b730b4" title="Creates a new connection handle for use by the FR connection API.">rest_socket_create</a>(<span class="keywordtype">void</span> *instance) 
<a name="l00272"></a>00272 {
<a name="l00273"></a>00273         <a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *<a class="code" href="rlm__mschap_8c.html#a5a012410c9dc2b8d34d0c5a49231a7e7">inst</a> = instance;
<a name="l00274"></a>00274 
<a name="l00275"></a>00275         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a>       *randle;
<a name="l00276"></a>00276         <a class="code" href="structrlm__rest__curl__context__t.html">rlm_rest_curl_context_t</a> *ctx;
<a name="l00277"></a>00277 
<a name="l00278"></a>00278         CURL *candle = curl_easy_init();
<a name="l00279"></a>00279         CURLcode ret;
<a name="l00280"></a>00280 
<a name="l00281"></a>00281         <span class="keywordflow">if</span> (!candle) {
<a name="l00282"></a>00282                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed to create CURL handle&quot;</span>, 
<a name="l00283"></a>00283                        inst-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l00284"></a>00284                 <span class="keywordflow">return</span> NULL;
<a name="l00285"></a>00285         }
<a name="l00286"></a>00286 
<a name="l00287"></a>00287         <span class="keywordflow">if</span> (!*inst-&gt;<a class="code" href="structrlm__rest__t.html#af6466f74c6783a280da8bc856f62aa9b">connect_uri</a>) {
<a name="l00288"></a>00288                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Skipping pre-connect,&quot;</span>
<a name="l00289"></a>00289                        <span class="stringliteral">&quot; connect_uri not specified&quot;</span>, inst-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l00290"></a>00290                 <span class="keywordflow">return</span> candle;
<a name="l00291"></a>00291         }
<a name="l00292"></a>00292 
<a name="l00293"></a>00293         <span class="comment">/*</span>
<a name="l00294"></a>00294 <span class="comment">         *      Pre-establish TCP connection to webserver. This would usually be</span>
<a name="l00295"></a>00295 <span class="comment">         *      done on the first request, but we do it here to minimise</span>
<a name="l00296"></a>00296 <span class="comment">         *      latency.</span>
<a name="l00297"></a>00297 <span class="comment">         */</span>
<a name="l00298"></a>00298         ret = curl_easy_setopt(candle, CURLOPT_CONNECT_ONLY, 1);
<a name="l00299"></a>00299         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00300"></a>00300 
<a name="l00301"></a>00301         ret = curl_easy_setopt(candle, CURLOPT_URL,
<a name="l00302"></a>00302                                inst-&gt;<a class="code" href="structrlm__rest__t.html#af6466f74c6783a280da8bc856f62aa9b">connect_uri</a>);
<a name="l00303"></a>00303         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l00304"></a>00304 
<a name="l00305"></a>00305         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#aa5f53e6fead7ace0a59f8efed49a8a6a">L_DBG</a>, <span class="stringliteral">&quot;rlm_rest (%s): Connecting to \&quot;%s\&quot;&quot;</span>,
<a name="l00306"></a>00306                inst-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>,
<a name="l00307"></a>00307                inst-&gt;<a class="code" href="structrlm__rest__t.html#af6466f74c6783a280da8bc856f62aa9b">connect_uri</a>);
<a name="l00308"></a>00308 
<a name="l00309"></a>00309         ret = curl_easy_perform(candle);
<a name="l00310"></a>00310         <span class="keywordflow">if</span> (ret != CURLE_OK) {
<a name="l00311"></a>00311                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Connection failed: %i - %s&quot;</span>,
<a name="l00312"></a>00312                         inst-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>,
<a name="l00313"></a>00313                         ret, curl_easy_strerror(ret));
<a name="l00314"></a>00314 
<a name="l00315"></a>00315                 <span class="keywordflow">goto</span> connection_error;
<a name="l00316"></a>00316         }
<a name="l00317"></a>00317 
<a name="l00318"></a>00318         <span class="comment">/* </span>
<a name="l00319"></a>00319 <span class="comment">         *      Malloc memory for the connection handle abstraction.</span>
<a name="l00320"></a>00320 <span class="comment">         */</span>
<a name="l00321"></a>00321         randle = malloc(<span class="keyword">sizeof</span>(*randle));
<a name="l00322"></a>00322         memset(randle, 0, <span class="keyword">sizeof</span>(*randle));
<a name="l00323"></a>00323 
<a name="l00324"></a>00324         ctx = malloc(<span class="keyword">sizeof</span>(*ctx));
<a name="l00325"></a>00325         memset(ctx, 0, <span class="keyword">sizeof</span>(*ctx));
<a name="l00326"></a>00326 
<a name="l00327"></a>00327         ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> = NULL; <span class="comment">/* CURL needs this to be NULL */</span>
<a name="l00328"></a>00328         ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a30545c830b99de10dc8f2666cf3db8e5">read</a>.<a class="code" href="structrlm__rest__read__t.html#ac0c2ec5ea1ace83751c92424387aae08">instance</a> = inst;
<a name="l00329"></a>00329 
<a name="l00330"></a>00330         randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#af06d12808076ebfa35b04a35c98584bf">ctx</a> = ctx;
<a name="l00331"></a>00331         randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a> = candle;
<a name="l00332"></a>00332 
<a name="l00333"></a>00333         <span class="comment">/*</span>
<a name="l00334"></a>00334 <span class="comment">         *      Clear any previously configured options for the first request.</span>
<a name="l00335"></a>00335 <span class="comment">         */</span>
<a name="l00336"></a>00336         curl_easy_reset(candle);
<a name="l00337"></a>00337 
<a name="l00338"></a>00338         <span class="keywordflow">return</span> randle;
<a name="l00339"></a>00339 
<a name="l00340"></a>00340         <span class="comment">/*</span>
<a name="l00341"></a>00341 <span class="comment">         *      Cleanup for error conditions.</span>
<a name="l00342"></a>00342 <span class="comment">         */</span>
<a name="l00343"></a>00343         error:
<a name="l00344"></a>00344 
<a name="l00345"></a>00345         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed setting curl option: %i - %s&quot;</span>,
<a name="l00346"></a>00346                         inst-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>,
<a name="l00347"></a>00347                         ret, curl_easy_strerror(ret));
<a name="l00348"></a>00348 
<a name="l00349"></a>00349         <span class="comment">/* </span>
<a name="l00350"></a>00350 <span class="comment">         *      So we don&#39;t leak CURL handles.</span>
<a name="l00351"></a>00351 <span class="comment">         */</span>
<a name="l00352"></a>00352         connection_error:
<a name="l00353"></a>00353 
<a name="l00354"></a>00354         curl_easy_cleanup(candle);
<a name="l00355"></a>00355 
<a name="l00356"></a>00356         <span class="keywordflow">return</span> NULL;
<a name="l00357"></a>00357 }
<a name="l00358"></a>00358 
<a name="l00369"></a><a class="code" href="rest_8h.html#a1734ced67b5fc48a1e470cccd293335f">00369</a> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a1734ced67b5fc48a1e470cccd293335f" title="Verifies that the last TCP socket associated with a handle is still active.">rest_socket_alive</a>(<span class="keywordtype">void</span> *instance, <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>)
<a name="l00370"></a>00370 {
<a name="l00371"></a>00371         <a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *<a class="code" href="rlm__mschap_8c.html#a5a012410c9dc2b8d34d0c5a49231a7e7">inst</a>                = instance;
<a name="l00372"></a>00372         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *randle       = <a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>;
<a name="l00373"></a>00373         CURL *candle                    = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a>;
<a name="l00374"></a>00374 
<a name="l00375"></a>00375         <span class="keywordtype">long</span> last_socket;
<a name="l00376"></a>00376         CURLcode ret;
<a name="l00377"></a>00377 
<a name="l00378"></a>00378         curl_easy_getinfo(candle, CURLINFO_LASTSOCKET, &amp;last_socket);
<a name="l00379"></a>00379         <span class="keywordflow">if</span> (ret != CURLE_OK) {
<a name="l00380"></a>00380                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>,
<a name="l00381"></a>00381                        <span class="stringliteral">&quot;rlm_rest (%s): Couldn&#39;t determine socket&quot;</span>
<a name="l00382"></a>00382                        <span class="stringliteral">&quot; state: %i - %s&quot;</span>, inst-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>, ret,
<a name="l00383"></a>00383                        curl_easy_strerror(ret));
<a name="l00384"></a>00384 
<a name="l00385"></a>00385                 <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00386"></a>00386         }
<a name="l00387"></a>00387 
<a name="l00388"></a>00388         <span class="keywordflow">if</span> (last_socket == -1) {
<a name="l00389"></a>00389                 <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00390"></a>00390         }
<a name="l00391"></a>00391 
<a name="l00392"></a>00392         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00393"></a>00393 }
<a name="l00394"></a>00394 
<a name="l00401"></a><a class="code" href="rest_8c.html#a2150b941de48b3f602439dd80aae1811">00401</a> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a2150b941de48b3f602439dd80aae1811" title="Frees a libcurl handle, and any additional memory used by context data.">rest_socket_delete</a>(<a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <span class="keywordtype">void</span> *instance, <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>)
<a name="l00402"></a>00402 {   
<a name="l00403"></a>00403         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *randle       = <a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>;
<a name="l00404"></a>00404         CURL *candle                    = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a>;
<a name="l00405"></a>00405 
<a name="l00406"></a>00406         curl_easy_cleanup(candle);
<a name="l00407"></a>00407 
<a name="l00408"></a>00408         free(randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#af06d12808076ebfa35b04a35c98584bf">ctx</a>);
<a name="l00409"></a>00409         free(randle);
<a name="l00410"></a>00410 
<a name="l00411"></a>00411         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l00412"></a>00412 }
<a name="l00413"></a>00413 
<a name="l00442"></a><a class="code" href="rest_8c.html#ab434441f64355ba1c46cd4ed51e45425">00442</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rest_8c.html#ab434441f64355ba1c46cd4ed51e45425" title="Encodes VALUE_PAIR linked list in POST format.">rest_encode_post</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb,
<a name="l00443"></a>00443                                <span class="keywordtype">void</span> *userdata)
<a name="l00444"></a>00444 {
<a name="l00445"></a>00445         <a class="code" href="structrlm__rest__read__t.html">rlm_rest_read_t</a> *ctx    = userdata;
<a name="l00446"></a>00446         <a class="code" href="structauth__req.html">REQUEST</a> *request        = ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a7cb029d789efd72a6c4931f03d8cf1f6">request</a>; <span class="comment">/* Used by RDEBUG */</span>
<a name="l00447"></a>00447         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> **current    = ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a06852bdecb7a31a68669bb7ff6af2d88">next</a>;
<a name="l00448"></a>00448 
<a name="l00449"></a>00449         <span class="keywordtype">char</span> *p = ptr;  <span class="comment">/* Position in buffer */</span>
<a name="l00450"></a>00450         <span class="keywordtype">char</span> *f = ptr;  <span class="comment">/* Position in buffer of last fully encoded attribute or value */</span>
<a name="l00451"></a>00451         <span class="keywordtype">char</span> *escaped;  <span class="comment">/* Pointer to current URL escaped data */</span>
<a name="l00452"></a>00452 
<a name="l00453"></a>00453         ssize_t len = 0;
<a name="l00454"></a>00454         ssize_t s = (size * nmemb) - 1;
<a name="l00455"></a>00455 
<a name="l00456"></a>00456         <span class="comment">/* Allow manual chunking */</span>
<a name="l00457"></a>00457         <span class="keywordflow">if</span> ((ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a0e1a10486d8fafdaef68557257524977">chunk</a>) &amp;&amp; (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a0e1a10486d8fafdaef68557257524977">chunk</a> &lt;= s)) {
<a name="l00458"></a>00458                 s = (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a0e1a10486d8fafdaef68557257524977">chunk</a> - 1);
<a name="l00459"></a>00459         }
<a name="l00460"></a>00460 
<a name="l00461"></a>00461         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> == <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a7cad4219ba15b545851943675e8b8eb3">READ_STATE_END</a>) <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00462"></a>00462 
<a name="l00463"></a>00463         <span class="comment">/* Post data requires no headers */</span>
<a name="l00464"></a>00464         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> == <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38aa2fb4cb0cd068faf164988ea6935ccc3">READ_STATE_INIT</a>) {
<a name="l00465"></a>00465                 ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a63fe6405d687cfe4af5f4d49772dc0ee">READ_STATE_ATTR_BEGIN</a>;
<a name="l00466"></a>00466         }
<a name="l00467"></a>00467 
<a name="l00468"></a>00468         <span class="keywordflow">while</span> (s &gt; 0) {
<a name="l00469"></a>00469                 <span class="keywordflow">if</span> (!*current) {
<a name="l00470"></a>00470                         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a7cad4219ba15b545851943675e8b8eb3">READ_STATE_END</a>;
<a name="l00471"></a>00471 
<a name="l00472"></a>00472                         <span class="keywordflow">goto</span> end_chunk;
<a name="l00473"></a>00473                 }
<a name="l00474"></a>00474 
<a name="l00475"></a>00475                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;Encoding attribute \&quot;%s\&quot;&quot;</span>, current[0]-&gt;<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00476"></a>00476 
<a name="l00477"></a>00477                 <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> == <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a63fe6405d687cfe4af5f4d49772dc0ee">READ_STATE_ATTR_BEGIN</a>) {
<a name="l00478"></a>00478                         escaped = curl_escape(current[0]-&gt;<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>,
<a name="l00479"></a>00479                                               strlen(current[0]-&gt;<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>));
<a name="l00480"></a>00480                         len = strlen(escaped);
<a name="l00481"></a>00481 
<a name="l00482"></a>00482                         <span class="keywordflow">if</span> (s &lt; (1 + len)) {
<a name="l00483"></a>00483                                 curl_free(escaped);
<a name="l00484"></a>00484                                 <span class="keywordflow">goto</span> no_space;
<a name="l00485"></a>00485                         }
<a name="l00486"></a>00486 
<a name="l00487"></a>00487                         len = sprintf(p, <span class="stringliteral">&quot;%s=&quot;</span>, escaped);
<a name="l00488"></a>00488 
<a name="l00489"></a>00489                         curl_free(escaped);
<a name="l00490"></a>00490 
<a name="l00491"></a>00491                         p += len;
<a name="l00492"></a>00492                         s -= len;
<a name="l00493"></a>00493 
<a name="l00494"></a>00494                         <span class="comment">/* </span>
<a name="l00495"></a>00495 <span class="comment">                         *      We wrote the attribute header, record progress.</span>
<a name="l00496"></a>00496 <span class="comment">                         */</span>
<a name="l00497"></a>00497                         f = p;
<a name="l00498"></a>00498                         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a07fc43132ce2372fc00211d351c93118">READ_STATE_ATTR_CONT</a>;
<a name="l00499"></a>00499                 }
<a name="l00500"></a>00500 
<a name="l00501"></a>00501                 <span class="comment">/*</span>
<a name="l00502"></a>00502 <span class="comment">                 *      Write out single attribute string.</span>
<a name="l00503"></a>00503 <span class="comment">                 */</span>
<a name="l00504"></a>00504                 len = <a class="code" href="libradius_8h.html#afd1dc1c8ef8a9684ed76740aa8c1e8ad">vp_prints_value</a>(p , s, current[0], 0);
<a name="l00505"></a>00505                 escaped = curl_escape(p, len);
<a name="l00506"></a>00506                 len = strlen(escaped);
<a name="l00507"></a>00507 
<a name="l00508"></a>00508                 <span class="keywordflow">if</span> (s &lt; len) {
<a name="l00509"></a>00509                         curl_free(escaped);
<a name="l00510"></a>00510                         <span class="keywordflow">goto</span> no_space;
<a name="l00511"></a>00511                 }
<a name="l00512"></a>00512 
<a name="l00513"></a>00513                 len = <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(p, escaped, len + 1);
<a name="l00514"></a>00514 
<a name="l00515"></a>00515                 curl_free(escaped);
<a name="l00516"></a>00516 
<a name="l00517"></a>00517                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;\tLength : %i&quot;</span>, len);
<a name="l00518"></a>00518                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;\tValue  : %s&quot;</span>, p);
<a name="l00519"></a>00519 
<a name="l00520"></a>00520                 p += len;
<a name="l00521"></a>00521                 s -= len;
<a name="l00522"></a>00522 
<a name="l00523"></a>00523                 <span class="keywordflow">if</span> (*++current) {
<a name="l00524"></a>00524                         <span class="keywordflow">if</span> (!--s) <span class="keywordflow">goto</span> no_space;
<a name="l00525"></a>00525                         *p++ = <span class="charliteral">&#39;&amp;&#39;</span>;
<a name="l00526"></a>00526                 }
<a name="l00527"></a>00527 
<a name="l00528"></a>00528                 <span class="comment">/* </span>
<a name="l00529"></a>00529 <span class="comment">                 *      We wrote one full attribute value pair, record progress.</span>
<a name="l00530"></a>00530 <span class="comment">                 */</span>
<a name="l00531"></a>00531                 f = p;
<a name="l00532"></a>00532                 ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a06852bdecb7a31a68669bb7ff6af2d88">next</a> = current;
<a name="l00533"></a>00533                 ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a63fe6405d687cfe4af5f4d49772dc0ee">READ_STATE_ATTR_BEGIN</a>;
<a name="l00534"></a>00534         }
<a name="l00535"></a>00535 
<a name="l00536"></a>00536         end_chunk:
<a name="l00537"></a>00537 
<a name="l00538"></a>00538         *p = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00539"></a>00539 
<a name="l00540"></a>00540         len = p - (<span class="keywordtype">char</span>*)ptr;
<a name="l00541"></a>00541 
<a name="l00542"></a>00542         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;POST Data: %s&quot;</span>, (<span class="keywordtype">char</span>*) ptr);
<a name="l00543"></a>00543         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;Returning %i bytes of POST data&quot;</span>, len);
<a name="l00544"></a>00544 
<a name="l00545"></a>00545         <span class="keywordflow">return</span> len;
<a name="l00546"></a>00546 
<a name="l00547"></a>00547         <span class="comment">/*</span>
<a name="l00548"></a>00548 <span class="comment">         *      Cleanup for error conditions</span>
<a name="l00549"></a>00549 <span class="comment">         */</span> 
<a name="l00550"></a>00550         no_space:
<a name="l00551"></a>00551 
<a name="l00552"></a>00552         *f = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00553"></a>00553 
<a name="l00554"></a>00554         len = f - (<span class="keywordtype">char</span>*)ptr;
<a name="l00555"></a>00555 
<a name="l00556"></a>00556         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;POST Data: %s&quot;</span>, (<span class="keywordtype">char</span>*) ptr);
<a name="l00557"></a>00557 
<a name="l00558"></a>00558         <span class="comment">/*</span>
<a name="l00559"></a>00559 <span class="comment">         *      The buffer wasn&#39;t big enough to encode a single attribute chunk.</span>
<a name="l00560"></a>00560 <span class="comment">         */</span>
<a name="l00561"></a>00561         <span class="keywordflow">if</span> (!len) {
<a name="l00562"></a>00562                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): AVP exceeds buffer length&quot;</span> 
<a name="l00563"></a>00563                        <span class="stringliteral">&quot; or chunk&quot;</span>, ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#ac0c2ec5ea1ace83751c92424387aae08">instance</a>-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l00564"></a>00564         } <span class="keywordflow">else</span> {
<a name="l00565"></a>00565                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;Returning %i bytes of POST data&quot;</span>
<a name="l00566"></a>00566                         <span class="stringliteral">&quot; (buffer full or chunk exceeded)&quot;</span>, len);
<a name="l00567"></a>00567         }
<a name="l00568"></a>00568 
<a name="l00569"></a>00569         <span class="keywordflow">return</span> len;
<a name="l00570"></a>00570 }
<a name="l00571"></a>00571 
<a name="l00609"></a><a class="code" href="rest_8c.html#a3cf8d055c2f101567cf335ad58c2d7e7">00609</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rest_8c.html#a3cf8d055c2f101567cf335ad58c2d7e7" title="Encodes VALUE_PAIR linked list in JSON format.">rest_encode_json</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb,
<a name="l00610"></a>00610                                <span class="keywordtype">void</span> *userdata)
<a name="l00611"></a>00611 {
<a name="l00612"></a>00612         <a class="code" href="structrlm__rest__read__t.html">rlm_rest_read_t</a> *ctx    = userdata;
<a name="l00613"></a>00613         <a class="code" href="structauth__req.html">REQUEST</a> *request        = ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a7cb029d789efd72a6c4931f03d8cf1f6">request</a>; <span class="comment">/* Used by RDEBUG */</span>
<a name="l00614"></a>00614         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> **current    = ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a06852bdecb7a31a68669bb7ff6af2d88">next</a>;
<a name="l00615"></a>00615 
<a name="l00616"></a>00616         <span class="keywordtype">char</span> *p = ptr;  <span class="comment">/* Position in buffer */</span>
<a name="l00617"></a>00617         <span class="keywordtype">char</span> *f = ptr;  <span class="comment">/* Position in buffer of last fully encoded attribute or value */</span>
<a name="l00618"></a>00618 
<a name="l00619"></a>00619         <span class="keyword">const</span> <span class="keywordtype">char</span> *type;
<a name="l00620"></a>00620 
<a name="l00621"></a>00621         ssize_t len = 0;
<a name="l00622"></a>00622         ssize_t s = (size * nmemb) - 1;
<a name="l00623"></a>00623 
<a name="l00624"></a>00624         assert(s &gt; 0);
<a name="l00625"></a>00625 
<a name="l00626"></a>00626         <span class="comment">/* Allow manual chunking */</span>
<a name="l00627"></a>00627         <span class="keywordflow">if</span> ((ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a0e1a10486d8fafdaef68557257524977">chunk</a>) &amp;&amp; (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a0e1a10486d8fafdaef68557257524977">chunk</a> &lt;= s)) {
<a name="l00628"></a>00628                 s = (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a0e1a10486d8fafdaef68557257524977">chunk</a> - 1);
<a name="l00629"></a>00629         }
<a name="l00630"></a>00630         
<a name="l00631"></a>00631         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> == <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a7cad4219ba15b545851943675e8b8eb3">READ_STATE_END</a>) <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l00632"></a>00632 
<a name="l00633"></a>00633         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> == <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38aa2fb4cb0cd068faf164988ea6935ccc3">READ_STATE_INIT</a>) {
<a name="l00634"></a>00634                 ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a63fe6405d687cfe4af5f4d49772dc0ee">READ_STATE_ATTR_BEGIN</a>;
<a name="l00635"></a>00635 
<a name="l00636"></a>00636                 <span class="keywordflow">if</span> (!--s) <span class="keywordflow">goto</span> no_space;
<a name="l00637"></a>00637                 *p++ = <span class="charliteral">&#39;{&#39;</span>;
<a name="l00638"></a>00638         }
<a name="l00639"></a>00639 
<a name="l00640"></a>00640         <span class="keywordflow">while</span> (s &gt; 0) {
<a name="l00641"></a>00641                 <span class="keywordflow">if</span> (!*current) {
<a name="l00642"></a>00642                         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a7cad4219ba15b545851943675e8b8eb3">READ_STATE_END</a>;
<a name="l00643"></a>00643 
<a name="l00644"></a>00644                         <span class="keywordflow">if</span> (!--s) <span class="keywordflow">goto</span> no_space;
<a name="l00645"></a>00645                         *p++ = <span class="charliteral">&#39;}&#39;</span>;
<a name="l00646"></a>00646 
<a name="l00647"></a>00647                         <span class="keywordflow">goto</span> end_chunk;
<a name="l00648"></a>00648                 }
<a name="l00649"></a>00649 
<a name="l00650"></a>00650                 <span class="comment">/*</span>
<a name="l00651"></a>00651 <span class="comment">                 *      New attribute, write name, type, and beginning of</span>
<a name="l00652"></a>00652 <span class="comment">                 *      value array.</span>
<a name="l00653"></a>00653 <span class="comment">                 */</span>
<a name="l00654"></a>00654                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;Encoding attribute \&quot;%s\&quot;&quot;</span>, current[0]-&gt;<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00655"></a>00655                 <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> == <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a63fe6405d687cfe4af5f4d49772dc0ee">READ_STATE_ATTR_BEGIN</a>) {
<a name="l00656"></a>00656                         type = <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(<a class="code" href="libradius_8h.html#a464de7dd5cdc5ce02d36c183ed6bea89">dict_attr_types</a>, current[0]-&gt;type,
<a name="l00657"></a>00657                                           <span class="stringliteral">&quot;¿Unknown?&quot;</span>);
<a name="l00658"></a>00658 
<a name="l00659"></a>00659                         len  = strlen(type);
<a name="l00660"></a>00660                         len += strlen(current[0]-&gt;<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>);
<a name="l00661"></a>00661 
<a name="l00662"></a>00662                         <span class="keywordflow">if</span> (s &lt; (23 + len)) <span class="keywordflow">goto</span> no_space;
<a name="l00663"></a>00663 
<a name="l00664"></a>00664                         len = sprintf(p, <span class="stringliteral">&quot;\&quot;%s\&quot;:{\&quot;type\&quot;:\&quot;%s\&quot;,\&quot;value\&quot;:[&quot;</span> ,
<a name="l00665"></a>00665                                       current[0]-&gt;<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, type);
<a name="l00666"></a>00666                         p += len;
<a name="l00667"></a>00667                         s -= len;
<a name="l00668"></a>00668 
<a name="l00669"></a>00669                         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tType   : %s&quot;</span>, type);
<a name="l00670"></a>00670 
<a name="l00671"></a>00671                         <span class="comment">/* </span>
<a name="l00672"></a>00672 <span class="comment">                         *      We wrote the attribute header, record progress</span>
<a name="l00673"></a>00673 <span class="comment">                         */</span>
<a name="l00674"></a>00674                         f = p;
<a name="l00675"></a>00675                         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a07fc43132ce2372fc00211d351c93118">READ_STATE_ATTR_CONT</a>;
<a name="l00676"></a>00676                 }
<a name="l00677"></a>00677 
<a name="l00678"></a>00678                 <span class="comment">/*</span>
<a name="l00679"></a>00679 <span class="comment">                 *      Put all attribute values in an array for easier remote</span>
<a name="l00680"></a>00680 <span class="comment">                 *      parsing whether they&#39;re multivalued or not.</span>
<a name="l00681"></a>00681 <span class="comment">                 */</span>
<a name="l00682"></a>00682                 <span class="keywordflow">while</span> (<a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) {
<a name="l00683"></a>00683                         len = <a class="code" href="libradius_8h.html#a2649dddf061d8d541364ca07c1c24578">vp_prints_value_json</a>(p , s, current[0]);
<a name="l00684"></a>00684                         assert((s - len) &gt;= 0);
<a name="l00685"></a>00685 
<a name="l00686"></a>00686                         <span class="keywordflow">if</span> (len &lt; 0) <span class="keywordflow">goto</span> no_space;
<a name="l00687"></a>00687 
<a name="l00688"></a>00688                         <span class="comment">/*</span>
<a name="l00689"></a>00689 <span class="comment">                         *      Show actual value length minus quotes</span>
<a name="l00690"></a>00690 <span class="comment">                         */</span>
<a name="l00691"></a>00691                         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tLength : %i&quot;</span>, (*p == <span class="charliteral">&#39;&quot;&#39;</span>) ? (len - 2) : len);
<a name="l00692"></a>00692                         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tValue  : %s&quot;</span>, p);
<a name="l00693"></a>00693 
<a name="l00694"></a>00694                         p += len;
<a name="l00695"></a>00695                         s -= len;
<a name="l00696"></a>00696 
<a name="l00697"></a>00697                         <span class="comment">/* </span>
<a name="l00698"></a>00698 <span class="comment">                         *      Multivalued attribute</span>
<a name="l00699"></a>00699 <span class="comment">                         */</span>
<a name="l00700"></a>00700                         <span class="keywordflow">if</span> (current[1] &amp;&amp; 
<a name="l00701"></a>00701                             ((current[0]-&gt;attribute == current[1]-&gt;attribute) &amp;&amp;
<a name="l00702"></a>00702                              (current[0]-&gt;vendor == current[1]-&gt;vendor))) {
<a name="l00703"></a>00703                                 *p++ = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00704"></a>00704                                 current++;
<a name="l00705"></a>00705 
<a name="l00706"></a>00706                                 <span class="comment">/* </span>
<a name="l00707"></a>00707 <span class="comment">                                 *      We wrote one attribute value, record</span>
<a name="l00708"></a>00708 <span class="comment">                                 *      progress.</span>
<a name="l00709"></a>00709 <span class="comment">                                 */</span>
<a name="l00710"></a>00710                                 f = p;
<a name="l00711"></a>00711                                 ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a06852bdecb7a31a68669bb7ff6af2d88">next</a> = current;
<a name="l00712"></a>00712                         } <span class="keywordflow">else</span> {
<a name="l00713"></a>00713                                 <span class="keywordflow">break</span>;
<a name="l00714"></a>00714                         }
<a name="l00715"></a>00715                 }
<a name="l00716"></a>00716 
<a name="l00717"></a>00717                 <span class="keywordflow">if</span> (!(s -= 2)) <span class="keywordflow">goto</span> no_space;
<a name="l00718"></a>00718                 *p++ = <span class="charliteral">&#39;]&#39;</span>;
<a name="l00719"></a>00719                 *p++ = <span class="charliteral">&#39;}&#39;</span>;
<a name="l00720"></a>00720 
<a name="l00721"></a>00721                 <span class="keywordflow">if</span> (*++current) {
<a name="l00722"></a>00722                         <span class="keywordflow">if</span> (!--s) <span class="keywordflow">goto</span> no_space;
<a name="l00723"></a>00723                         *p++ = <span class="charliteral">&#39;,&#39;</span>;
<a name="l00724"></a>00724                 }
<a name="l00725"></a>00725 
<a name="l00726"></a>00726                 <span class="comment">/* </span>
<a name="l00727"></a>00727 <span class="comment">                 *      We wrote one full attribute value pair, record progress.</span>
<a name="l00728"></a>00728 <span class="comment">                 */</span>
<a name="l00729"></a>00729                 f = p;
<a name="l00730"></a>00730                 ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a06852bdecb7a31a68669bb7ff6af2d88">next</a> = current;
<a name="l00731"></a>00731                 ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a> = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38a63fe6405d687cfe4af5f4d49772dc0ee">READ_STATE_ATTR_BEGIN</a>;
<a name="l00732"></a>00732         }
<a name="l00733"></a>00733 
<a name="l00734"></a>00734         end_chunk:
<a name="l00735"></a>00735 
<a name="l00736"></a>00736         *p = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00737"></a>00737 
<a name="l00738"></a>00738         len = p - (<span class="keywordtype">char</span>*)ptr;
<a name="l00739"></a>00739 
<a name="l00740"></a>00740         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;JSON Data: %s&quot;</span>, (<span class="keywordtype">char</span>*) ptr);
<a name="l00741"></a>00741         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;Returning %i bytes of JSON data&quot;</span>, len);
<a name="l00742"></a>00742 
<a name="l00743"></a>00743         <span class="keywordflow">return</span> len;
<a name="l00744"></a>00744 
<a name="l00745"></a>00745         <span class="comment">/* </span>
<a name="l00746"></a>00746 <span class="comment">         * Were out of buffer space</span>
<a name="l00747"></a>00747 <span class="comment">         */</span> 
<a name="l00748"></a>00748         no_space:
<a name="l00749"></a>00749 
<a name="l00750"></a>00750         *f = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l00751"></a>00751 
<a name="l00752"></a>00752         len = f - (<span class="keywordtype">char</span>*)ptr;
<a name="l00753"></a>00753 
<a name="l00754"></a>00754         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;JSON Data: %s&quot;</span>, (<span class="keywordtype">char</span>*) ptr);
<a name="l00755"></a>00755 
<a name="l00756"></a>00756         <span class="comment">/*</span>
<a name="l00757"></a>00757 <span class="comment">         *      The buffer wasn&#39;t big enough to encode a single attribute chunk.</span>
<a name="l00758"></a>00758 <span class="comment">         */</span>
<a name="l00759"></a>00759         <span class="keywordflow">if</span> (!len) {
<a name="l00760"></a>00760                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): AVP exceeds buffer length&quot;</span>
<a name="l00761"></a>00761                        <span class="stringliteral">&quot; or chunk&quot;</span>, ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#ac0c2ec5ea1ace83751c92424387aae08">instance</a>-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l00762"></a>00762         } <span class="keywordflow">else</span> {
<a name="l00763"></a>00763                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;Returning %i bytes of JSON data&quot;</span>
<a name="l00764"></a>00764                         <span class="stringliteral">&quot; (buffer full or chunk exceeded)&quot;</span>, len);
<a name="l00765"></a>00765         }
<a name="l00766"></a>00766 
<a name="l00767"></a>00767         <span class="keywordflow">return</span> len;
<a name="l00768"></a>00768 }
<a name="l00769"></a>00769 
<a name="l00794"></a><a class="code" href="rest_8c.html#ab71f5bb4f3ea89aa873fbd7e137e556b">00794</a> <span class="keyword">static</span> ssize_t <a class="code" href="rest_8c.html#ab71f5bb4f3ea89aa873fbd7e137e556b" title="Emulates successive libcurl calls to an encoding function.">rest_read_wrapper</a>(<span class="keywordtype">char</span> **buffer, <a class="code" href="rest_8h.html#a754712d2e6f1ae5cc9d701345aadf1f3">rest_read_t</a> func,
<a name="l00795"></a>00795                                  <span class="keywordtype">size_t</span> limit, <span class="keywordtype">void</span> *userdata)
<a name="l00796"></a>00796 {
<a name="l00797"></a>00797         <span class="keywordtype">char</span> *previous = NULL;
<a name="l00798"></a>00798         <span class="keywordtype">char</span> *current;
<a name="l00799"></a>00799 
<a name="l00800"></a>00800         <span class="keywordtype">size_t</span> alloc = <a class="code" href="rest_8h.html#a2181c78d485303a6cbb49e2b3aa36c9f">REST_BODY_INCR</a>;  <span class="comment">/* Size of buffer to malloc */</span>
<a name="l00801"></a>00801         <span class="keywordtype">size_t</span> used  = 0;               <span class="comment">/* Size of data written */</span>
<a name="l00802"></a>00802         <span class="keywordtype">size_t</span> len   = 0;
<a name="l00803"></a>00803 
<a name="l00804"></a>00804         <span class="keywordflow">while</span> (alloc &lt; limit) {
<a name="l00805"></a>00805                 current = <a class="code" href="radiusd_8h.html#aa6b2f20d83c5a77ba8961dc2aaa365fe">rad_malloc</a>(alloc);
<a name="l00806"></a>00806 
<a name="l00807"></a>00807                 <span class="keywordflow">if</span> (previous) {
<a name="l00808"></a>00808                         <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(current, previous, used + 1);
<a name="l00809"></a>00809                         free(previous);
<a name="l00810"></a>00810                 }
<a name="l00811"></a>00811 
<a name="l00812"></a>00812                 len = func(current + used, <a class="code" href="rest_8h.html#a2181c78d485303a6cbb49e2b3aa36c9f">REST_BODY_INCR</a>, 1, userdata);
<a name="l00813"></a>00813                 used += len;
<a name="l00814"></a>00814                 <span class="keywordflow">if</span> (!len) {
<a name="l00815"></a>00815                         *buffer = current;
<a name="l00816"></a>00816                         <span class="keywordflow">return</span> used;
<a name="l00817"></a>00817                 }
<a name="l00818"></a>00818 
<a name="l00819"></a>00819                 alloc += <a class="code" href="rest_8h.html#a2181c78d485303a6cbb49e2b3aa36c9f">REST_BODY_INCR</a>;
<a name="l00820"></a>00820                 previous = current;
<a name="l00821"></a>00821         };
<a name="l00822"></a>00822 
<a name="l00823"></a>00823         free(current);
<a name="l00824"></a>00824 
<a name="l00825"></a>00825         <span class="keywordflow">return</span> -1;
<a name="l00826"></a>00826 }
<a name="l00827"></a>00827 
<a name="l00851"></a><a class="code" href="rest_8c.html#a2d6e909e03e0aaab912cf82ca19ba0c6">00851</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rest_8c.html#a2d6e909e03e0aaab912cf82ca19ba0c6" title="(Re-)Initialises the data in a rlm_rest_read_t.">rest_read_ctx_init</a>(<a class="code" href="structauth__req.html">REQUEST</a> *request,
<a name="l00852"></a>00852                                <a class="code" href="structrlm__rest__read__t.html">rlm_rest_read_t</a> *ctx,
<a name="l00853"></a>00853                                <span class="keywordtype">boolean</span> <a class="code" href="radsniff_8c.html#a8591f5775cb15ff03d3542ba24cac6b6">sort</a>)
<a name="l00854"></a>00854 {
<a name="l00855"></a>00855         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> count = 0, i;
<a name="l00856"></a>00856         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> swap;
<a name="l00857"></a>00857 
<a name="l00858"></a>00858         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> **current, *tmp;
<a name="l00859"></a>00859 
<a name="l00860"></a>00860         <span class="comment">/*</span>
<a name="l00861"></a>00861 <span class="comment">         * Setup stream read data</span>
<a name="l00862"></a>00862 <span class="comment">         */</span>
<a name="l00863"></a>00863         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a7cb029d789efd72a6c4931f03d8cf1f6">request</a> = request;
<a name="l00864"></a>00864         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a786e6217f888dedf7eb04af2a796f80f">state</a>   = <a class="code" href="rest_8h.html#a52427918602bf0cbdc982efdd9d91a38aa2fb4cb0cd068faf164988ea6935ccc3">READ_STATE_INIT</a>;
<a name="l00865"></a>00865 
<a name="l00866"></a>00866         <span class="comment">/*</span>
<a name="l00867"></a>00867 <span class="comment">         * Create sorted array of VP pointers</span>
<a name="l00868"></a>00868 <span class="comment">         */</span>
<a name="l00869"></a>00869         tmp = request-&gt;<a class="code" href="structauth__req.html#aac70a60790c0f0d0fbd2d2acacbd78ec">packet</a>-&gt;<a class="code" href="structradius__packet.html#add39f5870ecff79da074d1936132ef12">vps</a>;
<a name="l00870"></a>00870         <span class="keywordflow">while</span> (tmp != NULL) {
<a name="l00871"></a>00871                 tmp = tmp-&gt;<a class="code" href="structvalue__pair.html#a7e9a8527578f32ee2273a0099aee436c">next</a>;
<a name="l00872"></a>00872                 count++;
<a name="l00873"></a>00873         }
<a name="l00874"></a>00874 
<a name="l00875"></a>00875         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a5556d1613c89f07b4d4aa5f3984d27fc">first</a> = current = <a class="code" href="radiusd_8h.html#aa6b2f20d83c5a77ba8961dc2aaa365fe">rad_malloc</a>((<span class="keyword">sizeof</span>(tmp) * (count + 1)));
<a name="l00876"></a>00876         ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a06852bdecb7a31a68669bb7ff6af2d88">next</a> = ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a5556d1613c89f07b4d4aa5f3984d27fc">first</a>;
<a name="l00877"></a>00877 
<a name="l00878"></a>00878         tmp = request-&gt;<a class="code" href="structauth__req.html#aac70a60790c0f0d0fbd2d2acacbd78ec">packet</a>-&gt;<a class="code" href="structradius__packet.html#add39f5870ecff79da074d1936132ef12">vps</a>;
<a name="l00879"></a>00879         <span class="keywordflow">while</span> (tmp != NULL) {
<a name="l00880"></a>00880                 *current++ = tmp;
<a name="l00881"></a>00881                 tmp = tmp-&gt;<a class="code" href="structvalue__pair.html#a7e9a8527578f32ee2273a0099aee436c">next</a>;
<a name="l00882"></a>00882         }
<a name="l00883"></a>00883         current[0] = NULL;
<a name="l00884"></a>00884         current = ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a5556d1613c89f07b4d4aa5f3984d27fc">first</a>;
<a name="l00885"></a>00885 
<a name="l00886"></a>00886         <span class="keywordflow">if</span> (!sort || (count &lt; 2)) <span class="keywordflow">return</span>;
<a name="l00887"></a>00887 
<a name="l00888"></a>00888         <span class="comment">/* TODO: Quicksort would be faster... */</span>
<a name="l00889"></a>00889         <span class="keywordflow">do</span> {
<a name="l00890"></a>00890                 <span class="keywordflow">for</span>(i = 1; i &lt; count; i++) {
<a name="l00891"></a>00891                         assert(current[i-1]-&gt;attribute &amp;&amp;
<a name="l00892"></a>00892                                current[i]-&gt;attribute);
<a name="l00893"></a>00893 
<a name="l00894"></a>00894                         swap = 0;
<a name="l00895"></a>00895                         <span class="keywordflow">if</span> ((current[i-1]-&gt;vendor &gt; current[i]-&gt;vendor) ||
<a name="l00896"></a>00896                             ((current[i-1]-&gt;vendor == current[i]-&gt;vendor) &amp;&amp;
<a name="l00897"></a>00897                              (current[i-1]-&gt;attribute &gt; current[i]-&gt;attribute)
<a name="l00898"></a>00898                             )) {
<a name="l00899"></a>00899                                 tmp          = current[i];
<a name="l00900"></a>00900                                 current[i]   = current[i-1];
<a name="l00901"></a>00901                                 current[i-1] = tmp;
<a name="l00902"></a>00902                                 swap = 1;
<a name="l00903"></a>00903                         }
<a name="l00904"></a>00904                 }
<a name="l00905"></a>00905         } <span class="keywordflow">while</span> (swap);
<a name="l00906"></a>00906 }
<a name="l00907"></a>00907 
<a name="l00917"></a><a class="code" href="rest_8c.html#a88e265303baa86e23e2b95d3f9f2bf45">00917</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rest_8c.html#a88e265303baa86e23e2b95d3f9f2bf45" title="Frees the VALUE_PAIR array created by rest_read_ctx_init.">rest_read_ctx_free</a>(<a class="code" href="structrlm__rest__read__t.html">rlm_rest_read_t</a> *ctx)
<a name="l00918"></a>00918 {
<a name="l00919"></a>00919         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a5556d1613c89f07b4d4aa5f3984d27fc">first</a> != NULL) {
<a name="l00920"></a>00920                 free(ctx-&gt;<a class="code" href="structrlm__rest__read__t.html#a5556d1613c89f07b4d4aa5f3984d27fc">first</a>);
<a name="l00921"></a>00921         }
<a name="l00922"></a>00922 }
<a name="l00923"></a>00923 
<a name="l00933"></a><a class="code" href="rest_8c.html#a0da81f96a416a6b7b63b5a402c98e309">00933</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rest_8c.html#a0da81f96a416a6b7b63b5a402c98e309" title="Verify that value wasn&#39;t truncated when it was converted to a VALUE_PAIR.">rest_check_truncation</a>(<a class="code" href="structauth__req.html">REQUEST</a> *request, <span class="keyword">const</span> <span class="keywordtype">char</span> *raw,
<a name="l00934"></a>00934                                   <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> *vp)
<a name="l00935"></a>00935 {
<a name="l00936"></a>00936         <span class="keywordtype">char</span> cooked[1024];
<a name="l00937"></a>00937 
<a name="l00938"></a>00938         <a class="code" href="libradius_8h.html#afd1dc1c8ef8a9684ed76740aa8c1e8ad">vp_prints_value</a>(cooked, <span class="keyword">sizeof</span>(cooked), vp, 0);
<a name="l00939"></a>00939         <span class="keywordflow">if</span> (strcmp(raw, cooked) != 0) {
<a name="l00940"></a>00940                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;WARNING: Value-Pair does not match POST value, &quot;</span>
<a name="l00941"></a>00941                        <span class="stringliteral">&quot;truncation may have occurred&quot;</span>);
<a name="l00942"></a>00942                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;\tValue (pair) : \&quot;%s\&quot;&quot;</span>, cooked);
<a name="l00943"></a>00943                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;\tValue (post) : \&quot;%s\&quot;&quot;</span>, raw);
<a name="l00944"></a>00944         }
<a name="l00945"></a>00945 }
<a name="l00946"></a>00946 
<a name="l00968"></a><a class="code" href="rest_8c.html#a8ac753a6a37bc35d8e06f9bfe17e7fdc">00968</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a8ac753a6a37bc35d8e06f9bfe17e7fdc" title="Converts POST response into VALUE_PAIRs and adds them to the request.">rest_decode_post</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance,
<a name="l00969"></a>00969                             <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l00970"></a>00970                             <a class="code" href="structauth__req.html">REQUEST</a> *request, <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>, <span class="keywordtype">char</span> *raw,
<a name="l00971"></a>00971                             <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <span class="keywordtype">size_t</span> rawlen)
<a name="l00972"></a>00972 {
<a name="l00973"></a>00973         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *randle = <a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>;
<a name="l00974"></a>00974         CURL *candle              = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a>;
<a name="l00975"></a>00975 
<a name="l00976"></a>00976         <span class="keyword">const</span> <span class="keywordtype">char</span> *p = raw, *q;
<a name="l00977"></a>00977 
<a name="l00978"></a>00978         <span class="keyword">const</span> <span class="keywordtype">char</span> *attribute;
<a name="l00979"></a>00979         <span class="keywordtype">char</span> *<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>  = NULL;
<a name="l00980"></a>00980         <span class="keywordtype">char</span> *<a class="code" href="rlm__python_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a> = NULL;
<a name="l00981"></a>00981 
<a name="l00982"></a>00982         <span class="keyword">const</span> <a class="code" href="structdict__attr.html">DICT_ATTR</a> *da;
<a name="l00983"></a>00983         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> *vp;
<a name="l00984"></a>00984 
<a name="l00985"></a>00985         <span class="keyword">const</span> <a class="code" href="structdict__attr.html">DICT_ATTR</a> **current, *processed[<a class="code" href="rest_8h.html#a28ba7bd7a0fcbca6635ef2834a72141b">REST_BODY_MAX_ATTRS</a> + 1];
<a name="l00986"></a>00986         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> *tmp;
<a name="l00987"></a>00987 
<a name="l00988"></a>00988         <a class="code" href="radiusd_8h.html#ae249ced799da9b7157463ea237bd85a4">pair_lists_t</a> list;
<a name="l00989"></a>00989         <a class="code" href="structauth__req.html">REQUEST</a> *reference = request;
<a name="l00990"></a>00990         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> **vps;
<a name="l00991"></a>00991 
<a name="l00992"></a>00992         <span class="keywordtype">size_t</span> len;
<a name="l00993"></a>00993         <span class="keywordtype">int</span> curl_len; <span class="comment">/* Length from last curl_easy_unescape call */</span>
<a name="l00994"></a>00994 
<a name="l00995"></a>00995         <span class="keywordtype">int</span> count = 0;
<a name="l00996"></a>00996 
<a name="l00997"></a>00997         processed[0] = NULL;
<a name="l00998"></a>00998 
<a name="l00999"></a>00999         <span class="comment">/*</span>
<a name="l01000"></a>01000 <span class="comment">         * Empty response?</span>
<a name="l01001"></a>01001 <span class="comment">         */</span>
<a name="l01002"></a>01002         <span class="keywordflow">while</span> (isspace(*p)) p++;
<a name="l01003"></a>01003 
<a name="l01004"></a>01004         <span class="keywordflow">if</span> (p == NULL) <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01005"></a>01005 
<a name="l01006"></a>01006         <span class="keywordflow">while</span> (((q = strchr(p, <span class="charliteral">&#39;=&#39;</span>)) != NULL) &amp;&amp;
<a name="l01007"></a>01007                (count &lt; <a class="code" href="rest_8h.html#a28ba7bd7a0fcbca6635ef2834a72141b">REST_BODY_MAX_ATTRS</a>)) {
<a name="l01008"></a>01008                 attribute = <a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l01009"></a>01009                 reference = request;
<a name="l01010"></a>01010 
<a name="l01011"></a>01011                 name = curl_easy_unescape(candle, p, (q - p), &amp;curl_len);
<a name="l01012"></a>01012                 p = (q + 1);
<a name="l01013"></a>01013 
<a name="l01014"></a>01014                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Decoding attribute \&quot;%s\&quot;&quot;</span>, name);
<a name="l01015"></a>01015 
<a name="l01016"></a>01016                 <span class="keywordflow">if</span> (!<a class="code" href="radiusd_8h.html#a3f3ce96c4564cb5745ceb7bd1513b5d6" title="Resolve attribute name to a request.">radius_ref_request</a>(&amp;reference, &amp;attribute)) {
<a name="l01017"></a>01017                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;WARNING: Attribute name refers to outer request&quot;</span>
<a name="l01018"></a>01018                                <span class="stringliteral">&quot; but not in a tunnel, skipping&quot;</span>);
<a name="l01019"></a>01019 
<a name="l01020"></a>01020                         curl_free(name);
<a name="l01021"></a>01021 
<a name="l01022"></a>01022                         <span class="keywordflow">continue</span>;
<a name="l01023"></a>01023                 }
<a name="l01024"></a>01024 
<a name="l01025"></a>01025                 list = <a class="code" href="radiusd_8h.html#aa8c57d1c5e691928b72c7b1606f29292" title="Resolve attribute name to a list.">radius_list_name</a>(&amp;attribute, <a class="code" href="radiusd_8h.html#a1121ccc9b5ea18acadccc2b96c08d3f3aa8bdbce7ac5119beff735e7c2a469959">PAIR_LIST_REPLY</a>);
<a name="l01026"></a>01026                 <span class="keywordflow">if</span> (list == <a class="code" href="radiusd_8h.html#a1121ccc9b5ea18acadccc2b96c08d3f3adfd3443ffa6f7bb2396ad51242087efc">PAIR_LIST_UNKNOWN</a>) {
<a name="l01027"></a>01027                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;WARNING: Invalid list qualifier, skipping&quot;</span>);
<a name="l01028"></a>01028 
<a name="l01029"></a>01029                         curl_free(name);
<a name="l01030"></a>01030 
<a name="l01031"></a>01031                         <span class="keywordflow">continue</span>;
<a name="l01032"></a>01032                 }
<a name="l01033"></a>01033 
<a name="l01034"></a>01034                 da = <a class="code" href="libradius_8h.html#aba1767cbfc574837c997e3703dca35c6">dict_attrbyname</a>(attribute);
<a name="l01035"></a>01035                 <span class="keywordflow">if</span> (!da) {
<a name="l01036"></a>01036                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;WARNING: Attribute \&quot;%s\&quot; unknown, skipping&quot;</span>,
<a name="l01037"></a>01037                                attribute);
<a name="l01038"></a>01038 
<a name="l01039"></a>01039                         curl_free(name);
<a name="l01040"></a>01040 
<a name="l01041"></a>01041                         <span class="keywordflow">continue</span>;
<a name="l01042"></a>01042                 }
<a name="l01043"></a>01043 
<a name="l01044"></a>01044                 vps = <a class="code" href="radiusd_8h.html#a91575ea7f1c601ce316fa6865d3bb611" title="Resolve attribute pair_lists_t value to an attribute list.">radius_list</a>(reference, list);
<a name="l01045"></a>01045 
<a name="l01046"></a>01046                 assert(vps);
<a name="l01047"></a>01047 
<a name="l01048"></a>01048                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tType  : %s&quot;</span>, <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(<a class="code" href="libradius_8h.html#a464de7dd5cdc5ce02d36c183ed6bea89">dict_attr_types</a>, da-&gt;<a class="code" href="structdict__attr.html#ab6d4e457a564297ac7776a4ceb0cb84e">type</a>,
<a name="l01049"></a>01049                         <span class="stringliteral">&quot;¿Unknown?&quot;</span>));
<a name="l01050"></a>01050 
<a name="l01051"></a>01051                 q = strchr(p, <span class="charliteral">&#39;&amp;&#39;</span>);
<a name="l01052"></a>01052                 len = (q == NULL) ? (rawlen - (p - raw)) : (<span class="keywordtype">unsigned</span>)(q - p);
<a name="l01053"></a>01053 
<a name="l01054"></a>01054                 value = curl_easy_unescape(candle, p, len, &amp;curl_len);
<a name="l01055"></a>01055 
<a name="l01056"></a>01056                 <span class="comment">/* </span>
<a name="l01057"></a>01057 <span class="comment">                 *      If we found a delimiter we want to skip over it,</span>
<a name="l01058"></a>01058 <span class="comment">                 *      if we didn&#39;t we do *NOT* want to skip over the end</span>
<a name="l01059"></a>01059 <span class="comment">                 *      of the buffer...</span>
<a name="l01060"></a>01060 <span class="comment">                 */</span>
<a name="l01061"></a>01061                 p += (q == NULL) ? len : (len + 1);
<a name="l01062"></a>01062 
<a name="l01063"></a>01063                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tLength : %i&quot;</span>, curl_len);
<a name="l01064"></a>01064                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tValue  : \&quot;%s\&quot;&quot;</span>, value);
<a name="l01065"></a>01065 
<a name="l01066"></a>01066                 vp = <a class="code" href="libradius_8h.html#a3379a6b115845896bb0166dab1639ab4">paircreate</a>(da-&gt;<a class="code" href="structdict__attr.html#a532242581676d54bc2891c22f5924f1b">attr</a>, da-&gt;<a class="code" href="structdict__attr.html#aad036c5456ae92857b7bc6abef6c0120">vendor</a>, da-&gt;<a class="code" href="structdict__attr.html#ab6d4e457a564297ac7776a4ceb0cb84e">type</a>);
<a name="l01067"></a>01067                 <span class="keywordflow">if</span> (!vp) {
<a name="l01068"></a>01068                         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed creating&quot;</span>
<a name="l01069"></a>01069                                <span class="stringliteral">&quot; value-pair&quot;</span>, instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l01070"></a>01070 
<a name="l01071"></a>01071                         <span class="keywordflow">goto</span> error;
<a name="l01072"></a>01072                 }
<a name="l01073"></a>01073 
<a name="l01074"></a>01074                 vp-&gt;<a class="code" href="structvalue__pair.html#add008cfdb3791ff7f2fdcd8dff14c6dc">operator</a> = <a class="code" href="token_8h.html#af52c716ee40e807384a050043564416aa7391387ca2c5556a9e11d1b5b71b1340">T_OP_SET</a>;
<a name="l01075"></a>01075  
<a name="l01076"></a>01076                 <span class="comment">/*</span>
<a name="l01077"></a>01077 <span class="comment">                 *      Check to see if we&#39;ve already processed an</span>
<a name="l01078"></a>01078 <span class="comment">                 *      attribute of the same type if we have, change the op</span>
<a name="l01079"></a>01079 <span class="comment">                 *      from T_OP_ADD to T_OP_SET.</span>
<a name="l01080"></a>01080 <span class="comment">                 */</span>
<a name="l01081"></a>01081                 current = processed;
<a name="l01082"></a>01082                 <span class="keywordflow">while</span> (*current++) {
<a name="l01083"></a>01083                         <span class="keywordflow">if</span> ((current[0]-&gt;attr == da-&gt;<a class="code" href="structdict__attr.html#a532242581676d54bc2891c22f5924f1b">attr</a>) &amp;&amp;
<a name="l01084"></a>01084                             (current[0]-&gt;<a class="code" href="structdict__attr.html#aad036c5456ae92857b7bc6abef6c0120">vendor</a> == da-&gt;<a class="code" href="structdict__attr.html#aad036c5456ae92857b7bc6abef6c0120">vendor</a>)) {
<a name="l01085"></a>01085                                 vp-&gt;<a class="code" href="structvalue__pair.html#add008cfdb3791ff7f2fdcd8dff14c6dc">operator</a> = <a class="code" href="token_8h.html#af52c716ee40e807384a050043564416aa043013319f2a56143d9b97b293b3dca9">T_OP_ADD</a>;
<a name="l01086"></a>01086                                 <span class="keywordflow">break</span>;
<a name="l01087"></a>01087                         }
<a name="l01088"></a>01088                 }
<a name="l01089"></a>01089                 
<a name="l01090"></a>01090                 <span class="keywordflow">if</span> (vp-&gt;<a class="code" href="structvalue__pair.html#add008cfdb3791ff7f2fdcd8dff14c6dc">operator</a> != <a class="code" href="token_8h.html#af52c716ee40e807384a050043564416aa043013319f2a56143d9b97b293b3dca9">T_OP_ADD</a>) {
<a name="l01091"></a>01091                         current[0] = da;
<a name="l01092"></a>01092                         current[1] = NULL;
<a name="l01093"></a>01093                 }
<a name="l01094"></a>01094 
<a name="l01095"></a>01095                 tmp = <a class="code" href="libradius_8h.html#af39bb82768b6e2bc4ceeb6b1741e7b8c">pairparsevalue</a>(vp, value);
<a name="l01096"></a>01096                 <span class="keywordflow">if</span> (tmp == NULL) {
<a name="l01097"></a>01097                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Incompatible value assignment, skipping&quot;</span>);
<a name="l01098"></a>01098                         <a class="code" href="libradius_8h.html#a21abb78db9b0ff8c0d9951738a9fefb1">pairbasicfree</a>(vp);
<a name="l01099"></a>01099                         <span class="keywordflow">goto</span> skip;
<a name="l01100"></a>01100                 }
<a name="l01101"></a>01101                 vp = tmp;
<a name="l01102"></a>01102 
<a name="l01103"></a>01103                 <a class="code" href="rest_8c.html#a0da81f96a416a6b7b63b5a402c98e309" title="Verify that value wasn&#39;t truncated when it was converted to a VALUE_PAIR.">rest_check_truncation</a>(request, value, vp);
<a name="l01104"></a>01104 
<a name="l01105"></a>01105                 vp-&gt;<a class="code" href="structvalue__pair.html#af15f448d9ad5c523685f2242c9ef5c2d">flags</a>.<a class="code" href="structattr__flags.html#ad7730abaaf39c9fdc082c3322995c793">do_xlat</a> = 1;
<a name="l01106"></a>01106 
<a name="l01107"></a>01107                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Performing xlat expansion of response value&quot;</span>, value);
<a name="l01108"></a>01108                 <a class="code" href="radiusd_8h.html#a1905b9eda06946517eaea40577251bc6" title="Move pairs, replacing/over-writing them, and doing xlat.">pairxlatmove</a>(request, vps, &amp;vp);
<a name="l01109"></a>01109 
<a name="l01110"></a>01110                 <span class="keywordflow">if</span> (++count == <a class="code" href="rest_8h.html#a28ba7bd7a0fcbca6635ef2834a72141b">REST_BODY_MAX_ATTRS</a>) {
<a name="l01111"></a>01111                         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): At maximum&quot;</span>
<a name="l01112"></a>01112                                <span class="stringliteral">&quot; attribute limit&quot;</span>, instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l01113"></a>01113                         <span class="keywordflow">return</span> count;
<a name="l01114"></a>01114                 }
<a name="l01115"></a>01115 
<a name="l01116"></a>01116                 skip:
<a name="l01117"></a>01117 
<a name="l01118"></a>01118                 curl_free(name);
<a name="l01119"></a>01119                 curl_free(value);
<a name="l01120"></a>01120 
<a name="l01121"></a>01121                 <span class="keywordflow">continue</span>;
<a name="l01122"></a>01122 
<a name="l01123"></a>01123                 error:
<a name="l01124"></a>01124 
<a name="l01125"></a>01125                 curl_free(name);
<a name="l01126"></a>01126                 curl_free(value);
<a name="l01127"></a>01127 
<a name="l01128"></a>01128                 <span class="keywordflow">return</span> count;
<a name="l01129"></a>01129         }
<a name="l01130"></a>01130 
<a name="l01131"></a>01131         <span class="keywordflow">if</span> (!count) {
<a name="l01132"></a>01132                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Malformed POST data \&quot;%s\&quot;&quot;</span>,
<a name="l01133"></a>01133                        instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>, raw);
<a name="l01134"></a>01134         }
<a name="l01135"></a>01135 
<a name="l01136"></a>01136         <span class="keywordflow">return</span> count;
<a name="l01137"></a>01137 
<a name="l01138"></a>01138 }
<a name="l01139"></a>01139 
<a name="l01154"></a><a class="code" href="rest_8c.html#acb0aeb0572988634723a72ae1f4b1a13">01154</a> <span class="keyword">static</span> <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> *<a class="code" href="rest_8c.html#acb0aeb0572988634723a72ae1f4b1a13" title="Converts JSON &quot;value&quot; key into VALUE_PAIR.">json_pairmake_leaf</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance,
<a name="l01155"></a>01155                                       <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l01156"></a>01156                                       <a class="code" href="structauth__req.html">REQUEST</a> *request, <span class="keyword">const</span> <a class="code" href="structdict__attr.html">DICT_ATTR</a> *da,
<a name="l01157"></a>01157                                       <a class="code" href="structjson__flags.html" title="Flags to control the conversion of JSON values to VALUE_PAIRs.">json_flags_t</a> *flags, json_object *leaf)
<a name="l01158"></a>01158 {
<a name="l01159"></a>01159         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rlm__python_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;
<a name="l01160"></a>01160         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> *vp, *tmp;
<a name="l01161"></a>01161 
<a name="l01162"></a>01162         <span class="comment">/*</span>
<a name="l01163"></a>01163 <span class="comment">         *      Should encode any nested JSON structures into JSON strings.</span>
<a name="l01164"></a>01164 <span class="comment">         *</span>
<a name="l01165"></a>01165 <span class="comment">         *      &quot;I knew you liked JSON so I put JSON in your JSON!&quot;</span>
<a name="l01166"></a>01166 <span class="comment">         */</span>
<a name="l01167"></a>01167         value = json_object_get_string(leaf);
<a name="l01168"></a>01168 
<a name="l01169"></a>01169         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tType   : %s&quot;</span>, <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(<a class="code" href="libradius_8h.html#a464de7dd5cdc5ce02d36c183ed6bea89">dict_attr_types</a>, da-&gt;<a class="code" href="structdict__attr.html#ab6d4e457a564297ac7776a4ceb0cb84e">type</a>,
<a name="l01170"></a>01170                                             <span class="stringliteral">&quot;¿Unknown?&quot;</span>));
<a name="l01171"></a>01171         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tLength : %i&quot;</span>, strlen(value));
<a name="l01172"></a>01172         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;\tValue  : \&quot;%s\&quot;&quot;</span>, value);
<a name="l01173"></a>01173 
<a name="l01174"></a>01174         vp = <a class="code" href="libradius_8h.html#a3379a6b115845896bb0166dab1639ab4">paircreate</a>(da-&gt;<a class="code" href="structdict__attr.html#a532242581676d54bc2891c22f5924f1b">attr</a>, da-&gt;<a class="code" href="structdict__attr.html#aad036c5456ae92857b7bc6abef6c0120">vendor</a>, da-&gt;<a class="code" href="structdict__attr.html#ab6d4e457a564297ac7776a4ceb0cb84e">type</a>);
<a name="l01175"></a>01175         <span class="keywordflow">if</span> (!vp) {
<a name="l01176"></a>01176                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed creating value-pair&quot;</span>,
<a name="l01177"></a>01177                        instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l01178"></a>01178                 <span class="keywordflow">return</span> NULL;
<a name="l01179"></a>01179         }
<a name="l01180"></a>01180 
<a name="l01181"></a>01181         vp-&gt;<a class="code" href="structvalue__pair.html#add008cfdb3791ff7f2fdcd8dff14c6dc">operator</a> = flags-&gt;<a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284" title="The operator that determines how the new VP.">operator</a>;
<a name="l01182"></a>01182 
<a name="l01183"></a>01183         tmp = <a class="code" href="libradius_8h.html#af39bb82768b6e2bc4ceeb6b1741e7b8c">pairparsevalue</a>(vp, value);
<a name="l01184"></a>01184         <span class="keywordflow">if</span> (tmp == NULL) {
<a name="l01185"></a>01185                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Incompatible value assignment, skipping&quot;</span>);
<a name="l01186"></a>01186                 <a class="code" href="libradius_8h.html#a21abb78db9b0ff8c0d9951738a9fefb1">pairbasicfree</a>(vp);
<a name="l01187"></a>01187                 <span class="keywordflow">return</span> NULL;
<a name="l01188"></a>01188         }
<a name="l01189"></a>01189         vp = tmp;
<a name="l01190"></a>01190 
<a name="l01191"></a>01191         <a class="code" href="rest_8c.html#a0da81f96a416a6b7b63b5a402c98e309" title="Verify that value wasn&#39;t truncated when it was converted to a VALUE_PAIR.">rest_check_truncation</a>(request, value, vp);
<a name="l01192"></a>01192 
<a name="l01193"></a>01193         <span class="keywordflow">if</span> (flags-&gt;<a class="code" href="structjson__flags.html#a9b3a476a79eb7226929258f85b190ade" title="If TRUE value will be expanded with xlat.">do_xlat</a>) vp-&gt;<a class="code" href="structvalue__pair.html#af15f448d9ad5c523685f2242c9ef5c2d">flags</a>.<a class="code" href="structattr__flags.html#ad7730abaaf39c9fdc082c3322995c793">do_xlat</a> = 1;
<a name="l01194"></a>01194 
<a name="l01195"></a>01195         <span class="keywordflow">return</span> vp;
<a name="l01196"></a>01196 }
<a name="l01197"></a>01197 
<a name="l01248"></a><a class="code" href="rest_8c.html#ae070013a304fa7beb599179c595279cb">01248</a> <span class="keyword">static</span> <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> *<a class="code" href="rest_8c.html#ae070013a304fa7beb599179c595279cb" title="Processes JSON response and converts it into multiple VALUE_PAIRs.">json_pairmake</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance,
<a name="l01249"></a>01249                                  <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l01250"></a>01250                                  <a class="code" href="structauth__req.html">REQUEST</a> *request, json_object *<span class="keywordtype">object</span>,
<a name="l01251"></a>01251                                  <span class="keywordtype">int</span> level, <span class="keywordtype">int</span> *max_attrs)
<a name="l01252"></a>01252 {
<a name="l01253"></a>01253         <span class="keyword">const</span> <span class="keywordtype">char</span> *p;
<a name="l01254"></a>01254         <span class="keywordtype">char</span> *q;
<a name="l01255"></a>01255         
<a name="l01256"></a>01256         <span class="keyword">const</span> <span class="keywordtype">char</span> *<a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>, *attribute;
<a name="l01257"></a>01257 
<a name="l01258"></a>01258         <span class="keyword">struct </span>json_object *<a class="code" href="rlm__python_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>, *idx, *tmp;
<a name="l01259"></a>01259         <span class="keyword">struct </span>lh_entry *entry;
<a name="l01260"></a>01260         <a class="code" href="structjson__flags.html" title="Flags to control the conversion of JSON values to VALUE_PAIRs.">json_flags_t</a> flags;
<a name="l01261"></a>01261 
<a name="l01262"></a>01262         <span class="keyword">const</span> <a class="code" href="structdict__attr.html">DICT_ATTR</a> *da;
<a name="l01263"></a>01263         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> *vp;
<a name="l01264"></a>01264         
<a name="l01265"></a>01265         <a class="code" href="radiusd_8h.html#ae249ced799da9b7157463ea237bd85a4">pair_lists_t</a> list;
<a name="l01266"></a>01266         <a class="code" href="structauth__req.html">REQUEST</a> *reference = request;
<a name="l01267"></a>01267         <a class="code" href="structvalue__pair.html">VALUE_PAIR</a> **vps;
<a name="l01268"></a>01268 
<a name="l01269"></a>01269         <span class="keywordtype">int</span> i, len;
<a name="l01270"></a>01270 
<a name="l01271"></a>01271         <span class="keywordflow">if</span> (!json_object_is_type(<span class="keywordtype">object</span>, json_type_object)) {
<a name="l01272"></a>01272                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Can&#39;t process VP container, expected JSON object,&quot;</span>
<a name="l01273"></a>01273                        <span class="stringliteral">&quot; got \&quot;%s\&quot;, skipping&quot;</span>,
<a name="l01274"></a>01274                        json_object_get_type(<span class="keywordtype">object</span>));
<a name="l01275"></a>01275                 <span class="keywordflow">return</span> NULL;
<a name="l01276"></a>01276         }
<a name="l01277"></a>01277    
<a name="l01278"></a>01278         <span class="comment">/*</span>
<a name="l01279"></a>01279 <span class="comment">         *      Process VP container</span>
<a name="l01280"></a>01280 <span class="comment">         */</span>
<a name="l01281"></a>01281         entry = json_object_get_object(<span class="keywordtype">object</span>)-&gt;head;
<a name="l01282"></a>01282         <span class="keywordflow">while</span> (entry) {
<a name="l01283"></a>01283                 flags.<a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284" title="The operator that determines how the new VP.">operator</a> = <a class="code" href="token_8h.html#af52c716ee40e807384a050043564416aa7391387ca2c5556a9e11d1b5b71b1340">T_OP_SET</a>;
<a name="l01284"></a>01284                 flags.<a class="code" href="structjson__flags.html#a9b3a476a79eb7226929258f85b190ade" title="If TRUE value will be expanded with xlat.">do_xlat</a>  = 1;
<a name="l01285"></a>01285                 flags.<a class="code" href="structjson__flags.html#aa65e14f7293634b47659ac9b05e7483d" title="If TRUE value will be inserted as raw JSON.">is_json</a>  = 0;
<a name="l01286"></a>01286 
<a name="l01287"></a>01287                 name = (<span class="keywordtype">char</span>*)entry-&gt;k;
<a name="l01288"></a>01288 
<a name="l01289"></a>01289                 <span class="comment">/* Fix the compiler warnings regarding const... */</span>
<a name="l01290"></a>01290                 memcpy(&amp;value, &amp;entry-&gt;v, <span class="keyword">sizeof</span>(value)); 
<a name="l01291"></a>01291 
<a name="l01292"></a>01292                 entry = entry-&gt;next;
<a name="l01293"></a>01293    
<a name="l01294"></a>01294                 <span class="comment">/*</span>
<a name="l01295"></a>01295 <span class="comment">                 *      For people handcrafting JSON responses</span>
<a name="l01296"></a>01296 <span class="comment">                 */</span>
<a name="l01297"></a>01297                 p = <a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l01298"></a>01298                 <span class="keywordflow">while</span> ((p = q = strchr(p, <span class="charliteral">&#39;|&#39;</span>))) {
<a name="l01299"></a>01299                         *q = <span class="charliteral">&#39;:&#39;</span>;
<a name="l01300"></a>01300                         p++;
<a name="l01301"></a>01301                 }
<a name="l01302"></a>01302 
<a name="l01303"></a>01303                 attribute = <a class="code" href="rlm__python_8c.html#a8f8f80d37794cde9472343e4487ba3eb">name</a>;
<a name="l01304"></a>01304                 reference = request;
<a name="l01305"></a>01305          
<a name="l01306"></a>01306                 <span class="comment">/*</span>
<a name="l01307"></a>01307 <span class="comment">                 *      Resolve attribute name to a dictionary entry and</span>
<a name="l01308"></a>01308 <span class="comment">                 *      pairlist.</span>
<a name="l01309"></a>01309 <span class="comment">                 */</span>
<a name="l01310"></a>01310                 <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;Decoding attribute \&quot;%s\&quot;&quot;</span>, name);
<a name="l01311"></a>01311 
<a name="l01312"></a>01312                 <span class="keywordflow">if</span> (!<a class="code" href="radiusd_8h.html#a3f3ce96c4564cb5745ceb7bd1513b5d6" title="Resolve attribute name to a request.">radius_ref_request</a>(&amp;reference, &amp;attribute)) {
<a name="l01313"></a>01313                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;WARNING: Attribute name refers to outer request&quot;</span>
<a name="l01314"></a>01314                                <span class="stringliteral">&quot; but not in a tunnel, skipping&quot;</span>);
<a name="l01315"></a>01315 
<a name="l01316"></a>01316                         <span class="keywordflow">continue</span>;
<a name="l01317"></a>01317                 }
<a name="l01318"></a>01318 
<a name="l01319"></a>01319                 list = <a class="code" href="radiusd_8h.html#aa8c57d1c5e691928b72c7b1606f29292" title="Resolve attribute name to a list.">radius_list_name</a>(&amp;attribute, <a class="code" href="radiusd_8h.html#a1121ccc9b5ea18acadccc2b96c08d3f3aa8bdbce7ac5119beff735e7c2a469959">PAIR_LIST_REPLY</a>);
<a name="l01320"></a>01320                 <span class="keywordflow">if</span> (list == <a class="code" href="radiusd_8h.html#a1121ccc9b5ea18acadccc2b96c08d3f3adfd3443ffa6f7bb2396ad51242087efc">PAIR_LIST_UNKNOWN</a>) {
<a name="l01321"></a>01321                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;WARNING: Invalid list qualifier, skipping&quot;</span>);
<a name="l01322"></a>01322 
<a name="l01323"></a>01323                         <span class="keywordflow">continue</span>;
<a name="l01324"></a>01324                 }
<a name="l01325"></a>01325 
<a name="l01326"></a>01326                 da = <a class="code" href="libradius_8h.html#aba1767cbfc574837c997e3703dca35c6">dict_attrbyname</a>(attribute);
<a name="l01327"></a>01327                 <span class="keywordflow">if</span> (!da) {
<a name="l01328"></a>01328                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;WARNING: Attribute \&quot;%s\&quot; unknown, skipping&quot;</span>,
<a name="l01329"></a>01329                                attribute);
<a name="l01330"></a>01330 
<a name="l01331"></a>01331                         <span class="keywordflow">continue</span>;
<a name="l01332"></a>01332                 }
<a name="l01333"></a>01333 
<a name="l01334"></a>01334                 vps = <a class="code" href="radiusd_8h.html#a91575ea7f1c601ce316fa6865d3bb611" title="Resolve attribute pair_lists_t value to an attribute list.">radius_list</a>(reference, list);
<a name="l01335"></a>01335 
<a name="l01336"></a>01336                 assert(vps);
<a name="l01337"></a>01337 
<a name="l01338"></a>01338                 <span class="comment">/*</span>
<a name="l01339"></a>01339 <span class="comment">                 *      Alternate JSON structure that allows operator,</span>
<a name="l01340"></a>01340 <span class="comment">                 *      and other flags to be specified.</span>
<a name="l01341"></a>01341 <span class="comment">                 *</span>
<a name="l01342"></a>01342 <span class="comment">                 *      &quot;&lt;name&gt;&quot;:{</span>
<a name="l01343"></a>01343 <span class="comment">                 *              &quot;do_xlat&quot;:&lt;bool&gt;,</span>
<a name="l01344"></a>01344 <span class="comment">                 *              &quot;is_json&quot;:&lt;bool&gt;,</span>
<a name="l01345"></a>01345 <span class="comment">                 *              &quot;op&quot;:&quot;&lt;op&gt;&quot;,</span>
<a name="l01346"></a>01346 <span class="comment">                 *              &quot;value&quot;:&lt;value&gt;</span>
<a name="l01347"></a>01347 <span class="comment">                 *      }</span>
<a name="l01348"></a>01348 <span class="comment">                 *</span>
<a name="l01349"></a>01349 <span class="comment">                 *      Where value is a:</span>
<a name="l01350"></a>01350 <span class="comment">                 *        - []  Multivalued array</span>
<a name="l01351"></a>01351 <span class="comment">                 *        - {}  Nested Valuepair</span>
<a name="l01352"></a>01352 <span class="comment">                 *        - *   Integer or string value</span>
<a name="l01353"></a>01353 <span class="comment">                 */</span>
<a name="l01354"></a>01354                 <span class="keywordflow">if</span> (json_object_is_type(value, json_type_object)) {
<a name="l01355"></a>01355                         <span class="comment">/*</span>
<a name="l01356"></a>01356 <span class="comment">                         *      Process operator if present.</span>
<a name="l01357"></a>01357 <span class="comment">                         */</span>
<a name="l01358"></a>01358                         tmp = json_object_object_get(value, <span class="stringliteral">&quot;op&quot;</span>);
<a name="l01359"></a>01359                         <span class="keywordflow">if</span> (tmp) {
<a name="l01360"></a>01360                                 flags.<a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284" title="The operator that determines how the new VP.">operator</a> = <a class="code" href="token_8h.html#aa79c5188edefb696373a75cee4dc81e3">fr_str2int</a>(<a class="code" href="token_8h.html#a8387db2591785802f9a75f81da5430f3">fr_tokens</a>,
<a name="l01361"></a>01361                                                             json_object_get_string(tmp), 0);
<a name="l01362"></a>01362 
<a name="l01363"></a>01363                                 <span class="keywordflow">if</span> (!flags.<a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284" title="The operator that determines how the new VP.">operator</a>) {
<a name="l01364"></a>01364                                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Invalid operator value \&quot;%s\&quot;,&quot;</span>
<a name="l01365"></a>01365                                                <span class="stringliteral">&quot; skipping&quot;</span>, tmp);
<a name="l01366"></a>01366                                         <span class="keywordflow">continue</span>;
<a name="l01367"></a>01367                                 }
<a name="l01368"></a>01368                         }
<a name="l01369"></a>01369 
<a name="l01370"></a>01370                         <span class="comment">/*</span>
<a name="l01371"></a>01371 <span class="comment">                         *      Process optional do_xlat bool.</span>
<a name="l01372"></a>01372 <span class="comment">                         */</span>
<a name="l01373"></a>01373                         tmp = json_object_object_get(value, <span class="stringliteral">&quot;do_xlat&quot;</span>);
<a name="l01374"></a>01374                         <span class="keywordflow">if</span> (tmp) {
<a name="l01375"></a>01375                                 flags.<a class="code" href="structjson__flags.html#a9b3a476a79eb7226929258f85b190ade" title="If TRUE value will be expanded with xlat.">do_xlat</a> = json_object_get_boolean(tmp);
<a name="l01376"></a>01376                         }
<a name="l01377"></a>01377 
<a name="l01378"></a>01378                         <span class="comment">/*</span>
<a name="l01379"></a>01379 <span class="comment">                         *      Process optional is_json bool.</span>
<a name="l01380"></a>01380 <span class="comment">                         */</span>
<a name="l01381"></a>01381                         tmp = json_object_object_get(value, <span class="stringliteral">&quot;is_json&quot;</span>);
<a name="l01382"></a>01382                         <span class="keywordflow">if</span> (tmp) {
<a name="l01383"></a>01383                                 flags.<a class="code" href="structjson__flags.html#aa65e14f7293634b47659ac9b05e7483d" title="If TRUE value will be inserted as raw JSON.">is_json</a> = json_object_get_boolean(tmp);
<a name="l01384"></a>01384                         }
<a name="l01385"></a>01385 
<a name="l01386"></a>01386                         <span class="comment">/*</span>
<a name="l01387"></a>01387 <span class="comment">                         *      Value key must be present if were using</span>
<a name="l01388"></a>01388 <span class="comment">                         *      the expanded syntax.</span>
<a name="l01389"></a>01389 <span class="comment">                         */</span>
<a name="l01390"></a>01390                         value = json_object_object_get(value, <span class="stringliteral">&quot;value&quot;</span>);
<a name="l01391"></a>01391                         <span class="keywordflow">if</span> (!value) {
<a name="l01392"></a>01392                                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Value key missing, skipping&quot;</span>, value);
<a name="l01393"></a>01393                                 <span class="keywordflow">continue</span>;
<a name="l01394"></a>01394                         }
<a name="l01395"></a>01395                 }
<a name="l01396"></a>01396 
<a name="l01397"></a>01397         <span class="comment">/*</span>
<a name="l01398"></a>01398 <span class="comment">         *      Setup pairmake / recursion loop.</span>
<a name="l01399"></a>01399 <span class="comment">         */</span>
<a name="l01400"></a>01400         <span class="keywordflow">if</span> (!flags.<a class="code" href="structjson__flags.html#aa65e14f7293634b47659ac9b05e7483d" title="If TRUE value will be inserted as raw JSON.">is_json</a> &amp;&amp;
<a name="l01401"></a>01401             json_object_is_type(value, json_type_array)) {
<a name="l01402"></a>01402                 len = json_object_array_length(value);
<a name="l01403"></a>01403                 <span class="keywordflow">if</span> (!len) {
<a name="l01404"></a>01404                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Zero length value array, skipping&quot;</span>, value);
<a name="l01405"></a>01405                         <span class="keywordflow">continue</span>;
<a name="l01406"></a>01406                 }
<a name="l01407"></a>01407                 idx = json_object_array_get_idx(value, 0);
<a name="l01408"></a>01408         } <span class="keywordflow">else</span> {
<a name="l01409"></a>01409                 len = 1;
<a name="l01410"></a>01410                 idx = <a class="code" href="rlm__python_8c.html#ac4f474c82e82cbb89ca7c36dd52be0ed">value</a>;
<a name="l01411"></a>01411         }
<a name="l01412"></a>01412 
<a name="l01413"></a>01413         i = 0;
<a name="l01414"></a>01414         <span class="keywordflow">do</span> {
<a name="l01415"></a>01415                 <span class="keywordflow">if</span> (!(*max_attrs)--) {
<a name="l01416"></a>01416                                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): At maximum&quot;</span>
<a name="l01417"></a>01417                                        <span class="stringliteral">&quot; attribute limit&quot;</span>, instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l01418"></a>01418                                 <span class="keywordflow">return</span> NULL;
<a name="l01419"></a>01419                 }
<a name="l01420"></a>01420 
<a name="l01421"></a>01421                 <span class="comment">/*</span>
<a name="l01422"></a>01422 <span class="comment">                 *      Automagically switch the op for multivalued</span>
<a name="l01423"></a>01423 <span class="comment">                 *      attributes.</span>
<a name="l01424"></a>01424 <span class="comment">                 */</span>
<a name="l01425"></a>01425                 <span class="keywordflow">if</span> (((flags.<a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284" title="The operator that determines how the new VP.">operator</a> == <a class="code" href="token_8h.html#af52c716ee40e807384a050043564416aa7391387ca2c5556a9e11d1b5b71b1340">T_OP_SET</a>) ||
<a name="l01426"></a>01426                      (flags.<a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284" title="The operator that determines how the new VP.">operator</a> == <a class="code" href="token_8h.html#af52c716ee40e807384a050043564416aa5b42625edf7660a5411d22834533ecdf">T_OP_EQ</a>)) &amp;&amp; (len &gt; 1)) {
<a name="l01427"></a>01427                         flags.<a class="code" href="structjson__flags.html#a165922a692cafbdb02d9bf413e2c9284" title="The operator that determines how the new VP.">operator</a> = <a class="code" href="token_8h.html#af52c716ee40e807384a050043564416aa043013319f2a56143d9b97b293b3dca9">T_OP_ADD</a>;
<a name="l01428"></a>01428                 }
<a name="l01429"></a>01429 
<a name="l01430"></a>01430                 <span class="keywordflow">if</span> (!flags.<a class="code" href="structjson__flags.html#aa65e14f7293634b47659ac9b05e7483d" title="If TRUE value will be inserted as raw JSON.">is_json</a> &amp;&amp;
<a name="l01431"></a>01431                     json_object_is_type(value, json_type_object)) {
<a name="l01432"></a>01432                         <span class="comment">/* TODO: Insert nested VP into VP structure...*/</span>
<a name="l01433"></a>01433                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Found nested VP&quot;</span>, value);
<a name="l01434"></a>01434                         vp = <a class="code" href="rest_8c.html#ae070013a304fa7beb599179c595279cb" title="Processes JSON response and converts it into multiple VALUE_PAIRs.">json_pairmake</a>(instance, section,
<a name="l01435"></a>01435                                            request, value,
<a name="l01436"></a>01436                                            level + 1, max_attrs);
<a name="l01437"></a>01437                 } <span class="keywordflow">else</span> {
<a name="l01438"></a>01438                         vp = <a class="code" href="rest_8c.html#acb0aeb0572988634723a72ae1f4b1a13" title="Converts JSON &quot;value&quot; key into VALUE_PAIR.">json_pairmake_leaf</a>(instance, section,
<a name="l01439"></a>01439                                                 request, da, &amp;flags,
<a name="l01440"></a>01440                                                 idx);
<a name="l01441"></a>01441 
<a name="l01442"></a>01442                         <span class="keywordflow">if</span> (vp != NULL) {
<a name="l01443"></a>01443                                 <span class="keywordflow">if</span> (vp-&gt;<a class="code" href="structvalue__pair.html#af15f448d9ad5c523685f2242c9ef5c2d">flags</a>.<a class="code" href="structattr__flags.html#ad7730abaaf39c9fdc082c3322995c793">do_xlat</a>) {
<a name="l01444"></a>01444                                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Performing xlat&quot;</span>
<a name="l01445"></a>01445                                                <span class="stringliteral">&quot; expansion of response&quot;</span>
<a name="l01446"></a>01446                                                <span class="stringliteral">&quot; value&quot;</span>, value);
<a name="l01447"></a>01447                                 }
<a name="l01448"></a>01448 
<a name="l01449"></a>01449                                 <a class="code" href="radiusd_8h.html#a1905b9eda06946517eaea40577251bc6" title="Move pairs, replacing/over-writing them, and doing xlat.">pairxlatmove</a>(request, vps, &amp;vp);
<a name="l01450"></a>01450                         }
<a name="l01451"></a>01451                 }
<a name="l01452"></a>01452         } <span class="keywordflow">while</span> ((++i &lt; len) &amp;&amp; (idx = json_object_array_get_idx(value, i)));
<a name="l01453"></a>01453    }
<a name="l01454"></a>01454 
<a name="l01455"></a>01455    <span class="keywordflow">return</span> vp;
<a name="l01456"></a>01456 }
<a name="l01457"></a>01457 
<a name="l01476"></a><a class="code" href="rest_8c.html#a8ad2c9225b5020dc8007e464687fb602">01476</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a8ad2c9225b5020dc8007e464687fb602" title="Converts JSON response into VALUE_PAIRs and adds them to the request.">rest_decode_json</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance,
<a name="l01477"></a>01477                             <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l01478"></a>01478                             <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structauth__req.html">REQUEST</a> *request, <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>,
<a name="l01479"></a>01479                             <span class="keywordtype">char</span> *raw, <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <span class="keywordtype">size_t</span> rawlen)
<a name="l01480"></a>01480 {
<a name="l01481"></a>01481         <span class="keyword">const</span> <span class="keywordtype">char</span> *p = raw;
<a name="l01482"></a>01482         
<a name="l01483"></a>01483         <span class="keyword">struct </span>json_object *json;
<a name="l01484"></a>01484         
<a name="l01485"></a>01485         <span class="keywordtype">int</span> <a class="code" href="smblib-priv_8h.html#affe776513b24d84b39af8ab0930fef7f">max</a> = <a class="code" href="rest_8h.html#a28ba7bd7a0fcbca6635ef2834a72141b">REST_BODY_MAX_ATTRS</a>;
<a name="l01486"></a>01486 
<a name="l01487"></a>01487         <span class="comment">/*</span>
<a name="l01488"></a>01488 <span class="comment">         *      Empty response?</span>
<a name="l01489"></a>01489 <span class="comment">         */</span>
<a name="l01490"></a>01490         <span class="keywordflow">while</span> (isspace(*p)) p++;
<a name="l01491"></a>01491         <span class="keywordflow">if</span> (p == NULL) <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01492"></a>01492 
<a name="l01493"></a>01493         json = json_tokener_parse(p);
<a name="l01494"></a>01494         <span class="keywordflow">if</span> (!json) {
<a name="l01495"></a>01495                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Malformed JSON data \&quot;%s\&quot;&quot;</span>,
<a name="l01496"></a>01496                         instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>, raw);
<a name="l01497"></a>01497                 <span class="keywordflow">return</span> -1;
<a name="l01498"></a>01498         }
<a name="l01499"></a>01499 
<a name="l01500"></a>01500         <a class="code" href="rest_8c.html#ae070013a304fa7beb599179c595279cb" title="Processes JSON response and converts it into multiple VALUE_PAIRs.">json_pairmake</a>(instance, section, request, json, 0, &amp;max);
<a name="l01501"></a>01501 
<a name="l01502"></a>01502         <span class="comment">/*</span>
<a name="l01503"></a>01503 <span class="comment">         *      Decrement reference count for root object, should free entire</span>
<a name="l01504"></a>01504 <span class="comment">         *      JSON tree.</span>
<a name="l01505"></a>01505 <span class="comment">         */</span>
<a name="l01506"></a>01506         json_object_put(json);
<a name="l01507"></a>01507 
<a name="l01508"></a>01508         <span class="keywordflow">return</span> (<a class="code" href="rest_8h.html#a28ba7bd7a0fcbca6635ef2834a72141b">REST_BODY_MAX_ATTRS</a> - max);
<a name="l01509"></a>01509 }
<a name="l01510"></a>01510 
<a name="l01525"></a><a class="code" href="rest_8c.html#a88deee0c267cfc5af2ce96265faf2fa8">01525</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rest_8c.html#a88deee0c267cfc5af2ce96265faf2fa8" title="Processes incoming HTTP header data from libcurl.">rest_write_header</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb,
<a name="l01526"></a>01526                                 <span class="keywordtype">void</span> *userdata)
<a name="l01527"></a>01527 {
<a name="l01528"></a>01528         <a class="code" href="structrlm__rest__write__t.html">rlm_rest_write_t</a> *ctx  = userdata;
<a name="l01529"></a>01529         <a class="code" href="structauth__req.html">REQUEST</a> *request       = ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#af78c46f6bbb92348430abfa274339c9e">request</a>; <span class="comment">/* Used by RDEBUG */</span>
<a name="l01530"></a>01530         
<a name="l01531"></a>01531         <span class="keyword">const</span> <span class="keywordtype">char</span> *p = ptr, *q;
<a name="l01532"></a>01532         <span class="keywordtype">char</span> *tmp;
<a name="l01533"></a>01533 
<a name="l01534"></a>01534         <span class="keyword">const</span> <span class="keywordtype">size_t</span> t = (size * nmemb);
<a name="l01535"></a>01535         <span class="keywordtype">size_t</span> s = t;
<a name="l01536"></a>01536         <span class="keywordtype">size_t</span> len;
<a name="l01537"></a>01537 
<a name="l01538"></a>01538         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43">http_body_type_t</a> type;
<a name="l01539"></a>01539         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43">http_body_type_t</a> supp;
<a name="l01540"></a>01540 
<a name="l01541"></a>01541         <span class="keywordflow">switch</span> (ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#ab4ad6ef4a87c8df79a832401e2cfe8d7">state</a>)
<a name="l01542"></a>01542         {
<a name="l01543"></a>01543                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#ac9393dc84ee4af33f04eac4befa5fd98a18ac57e92c0b3022b16fcd40ae4e8460">WRITE_STATE_INIT</a>:
<a name="l01544"></a>01544                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Processing header&quot;</span>);
<a name="l01545"></a>01545 
<a name="l01546"></a>01546                         <span class="comment">/* </span>
<a name="l01547"></a>01547 <span class="comment">                         * HTTP/&lt;version&gt; &lt;reason_code&gt;[ &lt;reason_phrase&gt;]\r\n</span>
<a name="l01548"></a>01548 <span class="comment">                         *</span>
<a name="l01549"></a>01549 <span class="comment">                         * &quot;HTTP/1.1 &quot; (8) + &quot;100 &quot; (4) + &quot;\r\n&quot; (2) = 14</span>
<a name="l01550"></a>01550 <span class="comment">                         */</span>
<a name="l01551"></a>01551                         <span class="keywordflow">if</span> (s &lt; 14) <span class="keywordflow">goto</span> malformed;
<a name="l01552"></a>01552 
<a name="l01553"></a>01553                         <span class="comment">/* </span>
<a name="l01554"></a>01554 <span class="comment">                         * Check start of header matches...</span>
<a name="l01555"></a>01555 <span class="comment">                         */</span>
<a name="l01556"></a>01556                         <span class="keywordflow">if</span> (<a class="code" href="missing_8h.html#a3c28b90d7e1fc3e492c1fac0af04d21b">strncasecmp</a>(<span class="stringliteral">&quot;HTTP/&quot;</span>, p, 5) != 0) <span class="keywordflow">goto</span> malformed;
<a name="l01557"></a>01557 
<a name="l01558"></a>01558                         p += 5;
<a name="l01559"></a>01559                         s -= 5;
<a name="l01560"></a>01560 
<a name="l01561"></a>01561                         <span class="comment">/*</span>
<a name="l01562"></a>01562 <span class="comment">                         * Skip the version field, next space should mark start</span>
<a name="l01563"></a>01563 <span class="comment">                         * of reason_code.</span>
<a name="l01564"></a>01564 <span class="comment">                         */</span>
<a name="l01565"></a>01565                         q = memchr(p, <span class="charliteral">&#39; &#39;</span>, s);
<a name="l01566"></a>01566                         <span class="keywordflow">if</span> (q == NULL) <span class="keywordflow">goto</span> malformed;
<a name="l01567"></a>01567 
<a name="l01568"></a>01568                         s -= (q - p);
<a name="l01569"></a>01569                         p  = q;
<a name="l01570"></a>01570 
<a name="l01571"></a>01571                         <span class="comment">/* </span>
<a name="l01572"></a>01572 <span class="comment">                         * Process reason_code.</span>
<a name="l01573"></a>01573 <span class="comment">                         *</span>
<a name="l01574"></a>01574 <span class="comment">                         * &quot; 100&quot; (4) + &quot;\r\n&quot; (2) = 6</span>
<a name="l01575"></a>01575 <span class="comment">                         */</span>
<a name="l01576"></a>01576                         <span class="keywordflow">if</span> (s &lt; 6) <span class="keywordflow">goto</span> malformed;
<a name="l01577"></a>01577                         p++;
<a name="l01578"></a>01578                         s--;
<a name="l01579"></a>01579 
<a name="l01580"></a>01580                         <span class="comment">/* Char after reason code must be a space, or \r */</span>
<a name="l01581"></a>01581                         <span class="keywordflow">if</span> (!((p[3] == <span class="charliteral">&#39; &#39;</span>) || (p[3] == <span class="charliteral">&#39;\r&#39;</span>))) <span class="keywordflow">goto</span> malformed;
<a name="l01582"></a>01582 
<a name="l01583"></a>01583                         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a138ed12dedb393b5af83b0e6aa9ca956">code</a> = atoi(p);
<a name="l01584"></a>01584 
<a name="l01585"></a>01585                         <span class="comment">/*</span>
<a name="l01586"></a>01586 <span class="comment">                         * Process reason_phrase (if present).</span>
<a name="l01587"></a>01587 <span class="comment">                         */</span>
<a name="l01588"></a>01588                         <span class="keywordflow">if</span> (p[3] == <span class="charliteral">&#39; &#39;</span>) {
<a name="l01589"></a>01589                                 p += 4;
<a name="l01590"></a>01590                                 s -= 4;
<a name="l01591"></a>01591 
<a name="l01592"></a>01592                                 q = memchr(p, <span class="charliteral">&#39;\r&#39;</span>, s);
<a name="l01593"></a>01593                                 <span class="keywordflow">if</span> (q == NULL) <span class="keywordflow">goto</span> malformed;
<a name="l01594"></a>01594 
<a name="l01595"></a>01595                                 len = (q - p);
<a name="l01596"></a>01596 
<a name="l01597"></a>01597                                 tmp = <a class="code" href="radiusd_8h.html#aa6b2f20d83c5a77ba8961dc2aaa365fe">rad_malloc</a>(len + 1);
<a name="l01598"></a>01598                                 <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(tmp, p, len + 1);
<a name="l01599"></a>01599 
<a name="l01600"></a>01600                                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;\tStatus : %i (%s)&quot;</span>, ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a138ed12dedb393b5af83b0e6aa9ca956">code</a>, tmp);
<a name="l01601"></a>01601 
<a name="l01602"></a>01602                                 free(tmp);
<a name="l01603"></a>01603                         } <span class="keywordflow">else</span> {
<a name="l01604"></a>01604                                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;\tStatus : %i&quot;</span>, ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a138ed12dedb393b5af83b0e6aa9ca956">code</a>);
<a name="l01605"></a>01605                         }
<a name="l01606"></a>01606 
<a name="l01607"></a>01607                         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#ab4ad6ef4a87c8df79a832401e2cfe8d7">state</a> = <a class="code" href="rest_8h.html#ac9393dc84ee4af33f04eac4befa5fd98a91c0b548a2bff0899afeb95ef37a15f3">WRITE_STATE_PARSE_HEADERS</a>;
<a name="l01608"></a>01608 
<a name="l01609"></a>01609                         <span class="keywordflow">break</span>;
<a name="l01610"></a>01610 
<a name="l01611"></a>01611                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#ac9393dc84ee4af33f04eac4befa5fd98a91c0b548a2bff0899afeb95ef37a15f3">WRITE_STATE_PARSE_HEADERS</a>:
<a name="l01612"></a>01612                         <span class="keywordflow">if</span> ((s &gt;= 14) &amp;&amp;
<a name="l01613"></a>01613                             (<a class="code" href="missing_8h.html#a3c28b90d7e1fc3e492c1fac0af04d21b">strncasecmp</a>(<span class="stringliteral">&quot;Content-Type: &quot;</span>, p, 14) == 0)) {
<a name="l01614"></a>01614                                 p += 14;
<a name="l01615"></a>01615                                 s -= 14;
<a name="l01616"></a>01616 
<a name="l01617"></a>01617                                 <span class="comment">/* </span>
<a name="l01618"></a>01618 <span class="comment">                                 *      Check to see if there&#39;s a parameter</span>
<a name="l01619"></a>01619 <span class="comment">                                 *      separator.</span>
<a name="l01620"></a>01620 <span class="comment">                                 */</span>
<a name="l01621"></a>01621                                 q = memchr(p, <span class="charliteral">&#39;;&#39;</span>, s);
<a name="l01622"></a>01622 
<a name="l01623"></a>01623                                 <span class="comment">/*</span>
<a name="l01624"></a>01624 <span class="comment">                                 *      If there&#39;s not, find the end of this</span>
<a name="l01625"></a>01625 <span class="comment">                                 *      header.</span>
<a name="l01626"></a>01626 <span class="comment">                                 */</span>
<a name="l01627"></a>01627                                 <span class="keywordflow">if</span> (q == NULL) q = memchr(p, <span class="charliteral">&#39;\r&#39;</span>, s);
<a name="l01628"></a>01628 
<a name="l01629"></a>01629                                 len = (q == NULL) ? s : (<span class="keywordtype">unsigned</span>)(q - p);
<a name="l01630"></a>01630 
<a name="l01631"></a>01631                                 type = <a class="code" href="token_8h.html#acc491028c2115692e45546922bf99fd3">fr_substr2int</a>(http_content_type_table,
<a name="l01632"></a>01632                                         p, <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a4a3674c75efd39582b497441acf04d41">HTTP_BODY_UNKNOWN</a>,
<a name="l01633"></a>01633                                         len);
<a name="l01634"></a>01634 
<a name="l01635"></a>01635                                 supp = http_body_type_supported[type];
<a name="l01636"></a>01636 
<a name="l01637"></a>01637                                 tmp = <a class="code" href="radiusd_8h.html#aa6b2f20d83c5a77ba8961dc2aaa365fe">rad_malloc</a>(len + 1);
<a name="l01638"></a>01638                                 <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(tmp, p, len + 1);
<a name="l01639"></a>01639 
<a name="l01640"></a>01640                                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;\tType   : %s (%s)&quot;</span>,
<a name="l01641"></a>01641                                         <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(http_body_type_table, type,
<a name="l01642"></a>01642                                                 <span class="stringliteral">&quot;¿Unknown?&quot;</span>), tmp);
<a name="l01643"></a>01643 
<a name="l01644"></a>01644                                 free(tmp);
<a name="l01645"></a>01645 
<a name="l01646"></a>01646                                 <span class="keywordflow">if</span> (type == <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a4a3674c75efd39582b497441acf04d41">HTTP_BODY_UNKNOWN</a>) {
<a name="l01647"></a>01647                                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Couldn&#39;t determine type, using&quot;</span>
<a name="l01648"></a>01648                                                <span class="stringliteral">&quot; request type \&quot;%s\&quot;.&quot;</span>,
<a name="l01649"></a>01649                                                <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(http_body_type_table,
<a name="l01650"></a>01650                                                           ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a>,
<a name="l01651"></a>01651                                                           <span class="stringliteral">&quot;¿Unknown?&quot;</span>));
<a name="l01652"></a>01652 
<a name="l01653"></a>01653                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (supp == <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>) {
<a name="l01654"></a>01654                                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Type \&quot;%s\&quot; is currently&quot;</span>
<a name="l01655"></a>01655                                                <span class="stringliteral">&quot; unsupported&quot;</span>,
<a name="l01656"></a>01656                                                <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(http_body_type_table,
<a name="l01657"></a>01657                                                           type, <span class="stringliteral">&quot;¿Unknown?&quot;</span>));
<a name="l01658"></a>01658                                         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a> = <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>;
<a name="l01659"></a>01659 
<a name="l01660"></a>01660                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (supp == <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a8a3328b9f8f72b0801e0a36769f74cdb">HTTP_BODY_INVALID</a>) {
<a name="l01661"></a>01661                                         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Type \&quot;%s\&quot; is not a valid web&quot;</span>
<a name="l01662"></a>01662                                                <span class="stringliteral">&quot; API data markup format&quot;</span>,
<a name="l01663"></a>01663                                                <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(http_body_type_table,
<a name="l01664"></a>01664                                                           type, <span class="stringliteral">&quot;¿Unknown?&quot;</span>));
<a name="l01665"></a>01665 
<a name="l01666"></a>01666                                         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a> = <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a8a3328b9f8f72b0801e0a36769f74cdb">HTTP_BODY_INVALID</a>;
<a name="l01667"></a>01667 
<a name="l01668"></a>01668                                 } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type != ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a>) {
<a name="l01669"></a>01669                                         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a> = type;
<a name="l01670"></a>01670                                 }
<a name="l01671"></a>01671                         }
<a name="l01672"></a>01672                         <span class="keywordflow">break</span>;
<a name="l01673"></a>01673                         
<a name="l01674"></a>01674                 <span class="keywordflow">default</span>:
<a name="l01675"></a>01675                         <span class="keywordflow">break</span>;
<a name="l01676"></a>01676         }
<a name="l01677"></a>01677         <span class="keywordflow">return</span> t;
<a name="l01678"></a>01678 
<a name="l01679"></a>01679         malformed:
<a name="l01680"></a>01680 
<a name="l01681"></a>01681         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Incoming header was malformed&quot;</span>);
<a name="l01682"></a>01682         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a138ed12dedb393b5af83b0e6aa9ca956">code</a> = -1;
<a name="l01683"></a>01683 
<a name="l01684"></a>01684         <span class="keywordflow">return</span> (t - s);
<a name="l01685"></a>01685 }
<a name="l01686"></a>01686 
<a name="l01698"></a><a class="code" href="rest_8c.html#ad31b21480350ba053bfdb924b54432b5">01698</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rest_8c.html#ad31b21480350ba053bfdb924b54432b5" title="Processes incoming HTTP body data from libcurl.">rest_write_body</a>(<span class="keywordtype">void</span> *ptr, <span class="keywordtype">size_t</span> size, <span class="keywordtype">size_t</span> nmemb,
<a name="l01699"></a>01699                               <span class="keywordtype">void</span> *userdata)
<a name="l01700"></a>01700 {
<a name="l01701"></a>01701         <a class="code" href="structrlm__rest__write__t.html">rlm_rest_write_t</a> *ctx  = userdata;
<a name="l01702"></a>01702         <a class="code" href="structauth__req.html">REQUEST</a> *request       = ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#af78c46f6bbb92348430abfa274339c9e">request</a>; <span class="comment">/* Used by RDEBUG */</span>
<a name="l01703"></a>01703         
<a name="l01704"></a>01704         <span class="keyword">const</span> <span class="keywordtype">char</span> *p = ptr;
<a name="l01705"></a>01705         <span class="keywordtype">char</span> *tmp;
<a name="l01706"></a>01706 
<a name="l01707"></a>01707         <span class="keyword">const</span> <span class="keywordtype">size_t</span> t = (size * nmemb);
<a name="l01708"></a>01708 
<a name="l01709"></a>01709         <span class="comment">/*</span>
<a name="l01710"></a>01710 <span class="comment">         *      Any post processing of headers should go here...</span>
<a name="l01711"></a>01711 <span class="comment">         */</span>
<a name="l01712"></a>01712         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#ab4ad6ef4a87c8df79a832401e2cfe8d7">state</a> == <a class="code" href="rest_8h.html#ac9393dc84ee4af33f04eac4befa5fd98a91c0b548a2bff0899afeb95ef37a15f3">WRITE_STATE_PARSE_HEADERS</a>) {
<a name="l01713"></a>01713                 ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#ab4ad6ef4a87c8df79a832401e2cfe8d7">state</a> = <a class="code" href="rest_8h.html#ac9393dc84ee4af33f04eac4befa5fd98a938bde93b124a0f910ad330d15723f7f">WRITE_STATE_PARSE_CONTENT</a>;
<a name="l01714"></a>01714         }
<a name="l01715"></a>01715 
<a name="l01716"></a>01716         <span class="keywordflow">switch</span> (ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a>)
<a name="l01717"></a>01717         {
<a name="l01718"></a>01718                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>:
<a name="l01719"></a>01719                         <span class="keywordflow">return</span> t;
<a name="l01720"></a>01720 
<a name="l01721"></a>01721                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a8a3328b9f8f72b0801e0a36769f74cdb">HTTP_BODY_INVALID</a>:
<a name="l01722"></a>01722                         tmp = <a class="code" href="radiusd_8h.html#aa6b2f20d83c5a77ba8961dc2aaa365fe">rad_malloc</a>(t + 1);
<a name="l01723"></a>01723                         <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(tmp, p, t + 1);
<a name="l01724"></a>01724 
<a name="l01725"></a>01725                         <a class="code" href="radiusd_8h.html#a3739f353647f89fd0d141868e40eb2e7">RDEBUG2</a>(<span class="stringliteral">&quot;%s&quot;</span>, tmp);
<a name="l01726"></a>01726 
<a name="l01727"></a>01727                         free(tmp);
<a name="l01728"></a>01728 
<a name="l01729"></a>01729                         <span class="keywordflow">return</span> t;
<a name="l01730"></a>01730 
<a name="l01731"></a>01731                 <span class="keywordflow">default</span>:
<a name="l01732"></a>01732                         <span class="keywordflow">if</span> (t &gt; (ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a1c643b99579a1a38a895a32dd564ab49">alloc</a> - ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#aba9ff1fc10f3ed00f7e256ea8a887aa2">used</a>)) {
<a name="l01733"></a>01733                                 ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a1c643b99579a1a38a895a32dd564ab49">alloc</a> += ((t + 1) &gt; <a class="code" href="rest_8h.html#a2181c78d485303a6cbb49e2b3aa36c9f">REST_BODY_INCR</a>) ?
<a name="l01734"></a>01734                                         t + 1 : <a class="code" href="rest_8h.html#a2181c78d485303a6cbb49e2b3aa36c9f">REST_BODY_INCR</a>;
<a name="l01735"></a>01735 
<a name="l01736"></a>01736                                 tmp = ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a>;
<a name="l01737"></a>01737 
<a name="l01738"></a>01738                                 ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a> = <a class="code" href="radiusd_8h.html#aa6b2f20d83c5a77ba8961dc2aaa365fe">rad_malloc</a>(ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a1c643b99579a1a38a895a32dd564ab49">alloc</a>);
<a name="l01739"></a>01739 
<a name="l01740"></a>01740                                 <span class="comment">/* If data has been written previously */</span>
<a name="l01741"></a>01741                                 <span class="keywordflow">if</span> (tmp) {
<a name="l01742"></a>01742                                         <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a>, tmp,
<a name="l01743"></a>01743                                                (ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#aba9ff1fc10f3ed00f7e256ea8a887aa2">used</a> + 1));
<a name="l01744"></a>01744                                         free(tmp);
<a name="l01745"></a>01745                                 }
<a name="l01746"></a>01746                         }
<a name="l01747"></a>01747                         <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a> + ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#aba9ff1fc10f3ed00f7e256ea8a887aa2">used</a>, p, t + 1);
<a name="l01748"></a>01748                         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#aba9ff1fc10f3ed00f7e256ea8a887aa2">used</a> += t;
<a name="l01749"></a>01749 
<a name="l01750"></a>01750                         <span class="keywordflow">break</span>;
<a name="l01751"></a>01751         }
<a name="l01752"></a>01752 
<a name="l01753"></a>01753         <span class="keywordflow">return</span> t;
<a name="l01754"></a>01754 }
<a name="l01755"></a>01755 
<a name="l01769"></a><a class="code" href="rest_8c.html#a1d7816f2d318565786021817aeba101f">01769</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rest_8c.html#a1d7816f2d318565786021817aeba101f" title="(Re-)Initialises the data in a rlm_rest_write_t.">rest_write_ctx_init</a>(<a class="code" href="structauth__req.html">REQUEST</a> *request, <a class="code" href="structrlm__rest__write__t.html">rlm_rest_write_t</a> *ctx,
<a name="l01770"></a>01770                                 <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43">http_body_type_t</a> type)
<a name="l01771"></a>01771 {
<a name="l01772"></a>01772         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#af78c46f6bbb92348430abfa274339c9e">request</a>    = request;
<a name="l01773"></a>01773         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a>       = type;
<a name="l01774"></a>01774         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#ab4ad6ef4a87c8df79a832401e2cfe8d7">state</a>      = <a class="code" href="rest_8h.html#ac9393dc84ee4af33f04eac4befa5fd98a18ac57e92c0b3022b16fcd40ae4e8460">WRITE_STATE_INIT</a>;
<a name="l01775"></a>01775         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a1c643b99579a1a38a895a32dd564ab49">alloc</a>      = 0;
<a name="l01776"></a>01776         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#aba9ff1fc10f3ed00f7e256ea8a887aa2">used</a>       = 0;
<a name="l01777"></a>01777         ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a>     = NULL;
<a name="l01778"></a>01778 }
<a name="l01779"></a>01779 
<a name="l01784"></a><a class="code" href="rest_8c.html#a0dd236900db73e09b33522d2a1af54b1">01784</a> <span class="keyword">static</span> <span class="keywordtype">void</span> <a class="code" href="rest_8c.html#a0dd236900db73e09b33522d2a1af54b1" title="Frees the intermediary buffer created by rest_write.">rest_write_free</a>(<a class="code" href="structrlm__rest__write__t.html">rlm_rest_write_t</a> *ctx)
<a name="l01785"></a>01785 {
<a name="l01786"></a>01786         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a> != NULL) {
<a name="l01787"></a>01787                 free(ctx-&gt;<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a>);
<a name="l01788"></a>01788         }
<a name="l01789"></a>01789 }
<a name="l01790"></a>01790 
<a name="l01804"></a><a class="code" href="rest_8c.html#a961fe2c1327442f08fd9c491fff5d2a6">01804</a> <span class="keyword">static</span> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a961fe2c1327442f08fd9c491fff5d2a6" title="Configures body specific curlopts.">rest_request_config_body</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance,
<a name="l01805"></a>01805                                     <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l01806"></a>01806                                     <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>,
<a name="l01807"></a>01807                                     <a class="code" href="rest_8h.html#a754712d2e6f1ae5cc9d701345aadf1f3">rest_read_t</a> func)
<a name="l01808"></a>01808 {
<a name="l01809"></a>01809         <a class="code" href="structrlm__rest__curl__context__t.html">rlm_rest_curl_context_t</a> *ctx = handle-&gt;<a class="code" href="structrlm__rest__handle__t.html#af06d12808076ebfa35b04a35c98584bf">ctx</a>;
<a name="l01810"></a>01810         CURL *candle                 = handle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a>;
<a name="l01811"></a>01811 
<a name="l01812"></a>01812         ssize_t len;
<a name="l01813"></a>01813         CURLcode ret;
<a name="l01814"></a>01814 
<a name="l01815"></a>01815         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a9943c22f70d6c45536915bc490c9be56">chunk</a> &gt; 0) {
<a name="l01816"></a>01816                 ret = curl_easy_setopt(candle, CURLOPT_READDATA,
<a name="l01817"></a>01817                                        &amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a30545c830b99de10dc8f2666cf3db8e5">read</a>);
<a name="l01818"></a>01818                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01819"></a>01819 
<a name="l01820"></a>01820                 ret = curl_easy_setopt(candle, CURLOPT_READFUNCTION,
<a name="l01821"></a>01821                                        <a class="code" href="rest_8c.html#a3cf8d055c2f101567cf335ad58c2d7e7" title="Encodes VALUE_PAIR linked list in JSON format.">rest_encode_json</a>);
<a name="l01822"></a>01822                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01823"></a>01823         } <span class="keywordflow">else</span> {
<a name="l01824"></a>01824                 len = <a class="code" href="rest_8c.html#ab71f5bb4f3ea89aa873fbd7e137e556b" title="Emulates successive libcurl calls to an encoding function.">rest_read_wrapper</a>(&amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a24504ea891b3f35c42e37ea9d80fc00c">body</a>, func,
<a name="l01825"></a>01825                                         <a class="code" href="rest_8h.html#aa13d4ca0a7e8bd693bb3394be77db581">REST_BODY_MAX_LEN</a> , &amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a30545c830b99de10dc8f2666cf3db8e5">read</a>);
<a name="l01826"></a>01826                 <span class="keywordflow">if</span> (len &lt;= 0) {
<a name="l01827"></a>01827                         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed creating HTTP&quot;</span>
<a name="l01828"></a>01828                                <span class="stringliteral">&quot; body content&quot;</span>, instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l01829"></a>01829                         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01830"></a>01830                 }
<a name="l01831"></a>01831 
<a name="l01832"></a>01832                 ret = curl_easy_setopt(candle, CURLOPT_POSTFIELDS,
<a name="l01833"></a>01833                                        ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a24504ea891b3f35c42e37ea9d80fc00c">body</a>);
<a name="l01834"></a>01834                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01835"></a>01835 
<a name="l01836"></a>01836                 ret = curl_easy_setopt(candle, CURLOPT_POSTFIELDSIZE,
<a name="l01837"></a>01837                                        len);
<a name="l01838"></a>01838                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01839"></a>01839         }
<a name="l01840"></a>01840 
<a name="l01841"></a>01841         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l01842"></a>01842 
<a name="l01843"></a>01843         error:
<a name="l01844"></a>01844         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed setting curl option: %i - %s&quot;</span>,
<a name="l01845"></a>01845                 instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>, ret, curl_easy_strerror(ret));
<a name="l01846"></a>01846 
<a name="l01847"></a>01847         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l01848"></a>01848 }
<a name="l01849"></a>01849 
<a name="l01872"></a><a class="code" href="rest_8h.html#a0dd98f402cb3c570232c61ec6a8ba6ce">01872</a> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a0dd98f402cb3c570232c61ec6a8ba6ce" title="Configures request curlopts.">rest_request_config</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance, <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l01873"></a>01873                         <a class="code" href="structauth__req.html">REQUEST</a> *request, <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>, <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2">http_method_t</a> method,
<a name="l01874"></a>01874                         <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43">http_body_type_t</a> type, <span class="keywordtype">char</span> *uri)
<a name="l01875"></a>01875 {
<a name="l01876"></a>01876         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *randle       = <a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>;
<a name="l01877"></a>01877         <a class="code" href="structrlm__rest__curl__context__t.html">rlm_rest_curl_context_t</a> *ctx    = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#af06d12808076ebfa35b04a35c98584bf">ctx</a>;
<a name="l01878"></a>01878         CURL *candle                    = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a>;
<a name="l01879"></a>01879         
<a name="l01880"></a>01880         <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5">http_auth_type_t</a> auth = section-&gt;<a class="code" href="structrlm__rest__section__t.html#aa97c0dea0d4392f4982f6d7fe7c8fe70">auth</a>;
<a name="l01881"></a>01881 
<a name="l01882"></a>01882         CURLcode ret;
<a name="l01883"></a>01883         <span class="keywordtype">long</span> <a class="code" href="timestr_8c.html#a59313840f49962c071cdb1039231ac2c">val</a> = 1;
<a name="l01884"></a>01884 
<a name="l01885"></a>01885         <span class="keywordtype">char</span> buffer[512];
<a name="l01886"></a>01886 
<a name="l01887"></a>01887         buffer[(<span class="keyword">sizeof</span>(buffer) - 1)] = <span class="charliteral">&#39;\0&#39;</span>;
<a name="l01888"></a>01888 
<a name="l01889"></a>01889         <span class="comment">/*</span>
<a name="l01890"></a>01890 <span class="comment">         *      Setup any header options and generic headers.</span>
<a name="l01891"></a>01891 <span class="comment">         */</span>
<a name="l01892"></a>01892         ret = curl_easy_setopt(candle, CURLOPT_URL, uri);
<a name="l01893"></a>01893         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01894"></a>01894 
<a name="l01895"></a>01895         ret = curl_easy_setopt(candle, CURLOPT_USERAGENT, <span class="stringliteral">&quot;FreeRADIUS&quot;</span>);
<a name="l01896"></a>01896         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01897"></a>01897   
<a name="l01898"></a>01898         <a class="code" href="missing_8h.html#acc2509f3dc1aeb186437c3fd8412e69a">snprintf</a>(buffer, (<span class="keyword">sizeof</span>(buffer) - 1), <span class="stringliteral">&quot;Content-Type: %s&quot;</span>,
<a name="l01899"></a>01899                  <a class="code" href="token_8h.html#ad2f2d09b23cc5a7bc760aacafa278fdd">fr_int2str</a>(http_content_type_table, type, <span class="stringliteral">&quot;¿Unknown?&quot;</span>));
<a name="l01900"></a>01900         ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> = curl_slist_append(ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>, buffer);
<a name="l01901"></a>01901         <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>) <span class="keywordflow">goto</span> error_header;
<a name="l01902"></a>01902         
<a name="l01903"></a>01903         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a9c08ab23ffc01920df6ce32ea162f5fa">timeout</a>) {
<a name="l01904"></a>01904                 ret = curl_easy_setopt(candle, CURLOPT_TIMEOUT,
<a name="l01905"></a>01905                                        section-&gt;<a class="code" href="structrlm__rest__section__t.html#a9c08ab23ffc01920df6ce32ea162f5fa">timeout</a>);
<a name="l01906"></a>01906                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01907"></a>01907         }
<a name="l01908"></a>01908         
<a name="l01909"></a>01909         ret = curl_easy_setopt(candle, CURLOPT_PROTOCOLS,
<a name="l01910"></a>01910                                (CURLPROTO_HTTP | CURLPROTO_HTTPS));
<a name="l01911"></a>01911         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01912"></a>01912         
<a name="l01913"></a>01913         <span class="comment">/*</span>
<a name="l01914"></a>01914 <span class="comment">         *      FreeRADIUS custom headers</span>
<a name="l01915"></a>01915 <span class="comment">         */</span>
<a name="l01916"></a>01916         <a class="code" href="missing_8h.html#acc2509f3dc1aeb186437c3fd8412e69a">snprintf</a>(buffer, (<span class="keyword">sizeof</span>(buffer) - 1), <span class="stringliteral">&quot;X-FreeRADIUS-Section: %s&quot;</span>,
<a name="l01917"></a>01917                  section-&gt;<a class="code" href="structrlm__rest__section__t.html#a2eb148fa416a492c0235f62c97ff5c07">name</a>);
<a name="l01918"></a>01918         ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> = curl_slist_append(ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>, buffer);
<a name="l01919"></a>01919         <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>) <span class="keywordflow">goto</span> error_header;
<a name="l01920"></a>01920 
<a name="l01921"></a>01921         <a class="code" href="missing_8h.html#acc2509f3dc1aeb186437c3fd8412e69a">snprintf</a>(buffer, (<span class="keyword">sizeof</span>(buffer) - 1), <span class="stringliteral">&quot;X-FreeRADIUS-Server: %s&quot;</span>,
<a name="l01922"></a>01922                  request-&gt;<a class="code" href="structauth__req.html#ab662b6122708301196e8c6e240931a2e">server</a>);
<a name="l01923"></a>01923         ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> = curl_slist_append(ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>, buffer);
<a name="l01924"></a>01924         <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>) <span class="keywordflow">goto</span> error_header;
<a name="l01925"></a>01925 
<a name="l01926"></a>01926         <span class="comment">/*</span>
<a name="l01927"></a>01927 <span class="comment">         *      Configure HTTP verb (GET, POST, PUT, DELETE, other...)</span>
<a name="l01928"></a>01928 <span class="comment">         */</span>
<a name="l01929"></a>01929         <span class="keywordflow">switch</span> (method)
<a name="l01930"></a>01930         {
<a name="l01931"></a>01931                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a90754abc55dbb76862fa50abee5af659">HTTP_METHOD_GET</a> :
<a name="l01932"></a>01932                         ret = curl_easy_setopt(candle, CURLOPT_HTTPGET,
<a name="l01933"></a>01933                                                val);
<a name="l01934"></a>01934                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01935"></a>01935 
<a name="l01936"></a>01936                         <span class="keywordflow">break</span>;
<a name="l01937"></a>01937 
<a name="l01938"></a>01938                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a1944682922ac79b2e682312d8f3f71e2">HTTP_METHOD_POST</a> :
<a name="l01939"></a>01939                         ret = curl_easy_setopt(candle, CURLOPT_POST,
<a name="l01940"></a>01940                                                val);
<a name="l01941"></a>01941                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01942"></a>01942 
<a name="l01943"></a>01943                         <span class="keywordflow">break</span>;
<a name="l01944"></a>01944 
<a name="l01945"></a>01945                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2af7557927b605c64f35f629b43823b1c9">HTTP_METHOD_PUT</a> :
<a name="l01946"></a>01946                         ret = curl_easy_setopt(candle, CURLOPT_PUT,
<a name="l01947"></a>01947                                                val);
<a name="l01948"></a>01948                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01949"></a>01949 
<a name="l01950"></a>01950                         <span class="keywordflow">break</span>;
<a name="l01951"></a>01951 
<a name="l01952"></a>01952                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a761371f7807255b7912afbac2f665ffe">HTTP_METHOD_DELETE</a> :
<a name="l01953"></a>01953                         ret = curl_easy_setopt(candle, CURLOPT_HTTPGET,
<a name="l01954"></a>01954                                                val);
<a name="l01955"></a>01955                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01956"></a>01956 
<a name="l01957"></a>01957                         ret = curl_easy_setopt(candle,
<a name="l01958"></a>01958                                                CURLOPT_CUSTOMREQUEST, <span class="stringliteral">&quot;DELETE&quot;</span>);
<a name="l01959"></a>01959                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01960"></a>01960 
<a name="l01961"></a>01961                         <span class="keywordflow">break</span>;
<a name="l01962"></a>01962 
<a name="l01963"></a>01963                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2aa0ffdbe653c13c2595d290fb2b651db9">HTTP_METHOD_CUSTOM</a> :
<a name="l01964"></a>01964                         ret = curl_easy_setopt(candle, CURLOPT_HTTPGET,
<a name="l01965"></a>01965                                                val);
<a name="l01966"></a>01966                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01967"></a>01967 
<a name="l01968"></a>01968                         ret = curl_easy_setopt(candle,
<a name="l01969"></a>01969                                                CURLOPT_CUSTOMREQUEST,
<a name="l01970"></a>01970                                                section-&gt;<a class="code" href="structrlm__rest__section__t.html#ac349652d449546b70d8a4de7b554b9ca">method</a>);
<a name="l01971"></a>01971                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01972"></a>01972 
<a name="l01973"></a>01973                 <span class="keywordflow">default</span>:
<a name="l01974"></a>01974                         assert(0);
<a name="l01975"></a>01975                         <span class="keywordflow">break</span>;
<a name="l01976"></a>01976         };
<a name="l01977"></a>01977         
<a name="l01978"></a>01978         <span class="comment">/*</span>
<a name="l01979"></a>01979 <span class="comment">         *      Set user based authentication parameters</span>
<a name="l01980"></a>01980 <span class="comment">         */</span>
<a name="l01981"></a>01981         <span class="keywordflow">if</span> (auth) {
<a name="l01982"></a>01982                 <span class="keywordflow">if</span> ((auth &gt;= <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a946b7e60a754342e83205964b31a77ba">HTTP_AUTH_BASIC</a>) &amp;&amp;
<a name="l01983"></a>01983                     (auth &lt;= <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5afe11e217d1bdaa3d306d3b679d016414">HTTP_AUTH_ANY_SAFE</a>)) {
<a name="l01984"></a>01984                         ret = curl_easy_setopt(candle, CURLOPT_HTTPAUTH,
<a name="l01985"></a>01985                                                http_curl_auth[auth]);
<a name="l01986"></a>01986                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01987"></a>01987                         
<a name="l01988"></a>01988                         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#aea6abea62bc99ed4ec8127e277aa004a">username</a>) {
<a name="l01989"></a>01989                                 <a class="code" href="radiusd_8h.html#ac68b6c0454e5fdc86f5402299da73091" title="Replace whatever in a string.">radius_xlat</a>(buffer, <span class="keyword">sizeof</span>(buffer),
<a name="l01990"></a>01990                                             section-&gt;<a class="code" href="structrlm__rest__section__t.html#aea6abea62bc99ed4ec8127e277aa004a">username</a>, request, NULL, NULL);
<a name="l01991"></a>01991                                             
<a name="l01992"></a>01992                                 ret = curl_easy_setopt(candle, CURLOPT_USERNAME,
<a name="l01993"></a>01993                                                        buffer);
<a name="l01994"></a>01994                                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l01995"></a>01995                         }
<a name="l01996"></a>01996                         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a5df2c0e83e02fc552fa1be6b04f6e823">password</a>) {
<a name="l01997"></a>01997                                 <a class="code" href="radiusd_8h.html#ac68b6c0454e5fdc86f5402299da73091" title="Replace whatever in a string.">radius_xlat</a>(buffer, <span class="keyword">sizeof</span>(buffer),
<a name="l01998"></a>01998                                             section-&gt;<a class="code" href="structrlm__rest__section__t.html#a5df2c0e83e02fc552fa1be6b04f6e823">password</a>, request, NULL, NULL);
<a name="l01999"></a>01999                                             
<a name="l02000"></a>02000                                 ret = curl_easy_setopt(candle, CURLOPT_PASSWORD,
<a name="l02001"></a>02001                                                        buffer);
<a name="l02002"></a>02002                                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02003"></a>02003                         }
<a name="l02004"></a>02004 
<a name="l02005"></a>02005 <span class="preprocessor">#ifdef CURLOPT_TLSAUTH_USERNAME</span>
<a name="l02006"></a>02006 <span class="preprocessor"></span>                } <span class="keywordflow">else</span> <span class="keywordflow">if</span> (type == <a class="code" href="rest_8h.html#ad18ce766db31fff3efc1896156647fa5a752ceaf5e18fd71ccab046068141706c">HTTP_AUTH_TLS_SRP</a>) {
<a name="l02007"></a>02007                         ret = curl_easy_setopt(candle, CURLOPT_TLSAUTH_TYPE,
<a name="l02008"></a>02008                                                http_curl_auth[auth]);
<a name="l02009"></a>02009                 
<a name="l02010"></a>02010                         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#aea6abea62bc99ed4ec8127e277aa004a">username</a>) {
<a name="l02011"></a>02011                                 <a class="code" href="radiusd_8h.html#ac68b6c0454e5fdc86f5402299da73091" title="Replace whatever in a string.">radius_xlat</a>(buffer, <span class="keyword">sizeof</span>(buffer),
<a name="l02012"></a>02012                                             section-&gt;<a class="code" href="structrlm__rest__section__t.html#aea6abea62bc99ed4ec8127e277aa004a">username</a>, request, NULL, NULL);
<a name="l02013"></a>02013                                             
<a name="l02014"></a>02014                                 ret = curl_easy_setopt(candle,
<a name="l02015"></a>02015                                                        CURLOPT_TLSAUTH_USERNAME,
<a name="l02016"></a>02016                                                        buffer);
<a name="l02017"></a>02017                                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02018"></a>02018                         }
<a name="l02019"></a>02019                         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a5df2c0e83e02fc552fa1be6b04f6e823">password</a>) {
<a name="l02020"></a>02020                                 <a class="code" href="radiusd_8h.html#ac68b6c0454e5fdc86f5402299da73091" title="Replace whatever in a string.">radius_xlat</a>(buffer, <span class="keyword">sizeof</span>(buffer),
<a name="l02021"></a>02021                                             section-&gt;<a class="code" href="structrlm__rest__section__t.html#a5df2c0e83e02fc552fa1be6b04f6e823">password</a>, request, NULL, NULL);
<a name="l02022"></a>02022                                             
<a name="l02023"></a>02023                                 ret = curl_easy_setopt(candle,
<a name="l02024"></a>02024                                                        CURLOPT_TLSAUTH_PASSWORD,
<a name="l02025"></a>02025                                                        buffer);
<a name="l02026"></a>02026                                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02027"></a>02027                         }
<a name="l02028"></a>02028 <span class="preprocessor">#endif</span>
<a name="l02029"></a>02029 <span class="preprocessor"></span>                }
<a name="l02030"></a>02030         }
<a name="l02031"></a>02031         
<a name="l02032"></a>02032         <span class="comment">/*</span>
<a name="l02033"></a>02033 <span class="comment">         *      Set SSL authentication parameters</span>
<a name="l02034"></a>02034 <span class="comment">         */</span>
<a name="l02035"></a>02035         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a821e730f2e4e5e1e2c7792504f3a1386">certificate_file</a>) {
<a name="l02036"></a>02036                 ret = curl_easy_setopt(candle,
<a name="l02037"></a>02037                                        CURLOPT_SSLCERT,
<a name="l02038"></a>02038                                        section-&gt;<a class="code" href="structrlm__rest__section__t.html#a821e730f2e4e5e1e2c7792504f3a1386">certificate_file</a>);
<a name="l02039"></a>02039                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02040"></a>02040         }
<a name="l02041"></a>02041         
<a name="l02042"></a>02042         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#aec41154d23f72384c3ec6d263b25bb0e">file_type</a> == <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>) {
<a name="l02043"></a>02043                 ret = curl_easy_setopt(candle,
<a name="l02044"></a>02044                                        CURLOPT_SSLCERT,
<a name="l02045"></a>02045                                        <span class="stringliteral">&quot;DER&quot;</span>);
<a name="l02046"></a>02046                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02047"></a>02047         }
<a name="l02048"></a>02048         
<a name="l02049"></a>02049         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a1daf698ad021a34a17b564f932ffb84f">private_key_file</a>) {
<a name="l02050"></a>02050                 ret = curl_easy_setopt(candle,
<a name="l02051"></a>02051                                        CURLOPT_SSLCERT,
<a name="l02052"></a>02052                                        section-&gt;<a class="code" href="structrlm__rest__section__t.html#a1daf698ad021a34a17b564f932ffb84f">private_key_file</a>);
<a name="l02053"></a>02053                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02054"></a>02054         }
<a name="l02055"></a>02055 
<a name="l02056"></a>02056         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a11db55f380581de8b3d0ff9d018a594d">private_key_password</a>) {
<a name="l02057"></a>02057                 ret = curl_easy_setopt(candle,
<a name="l02058"></a>02058                                        CURLOPT_KEYPASSWD,
<a name="l02059"></a>02059                                        section-&gt;<a class="code" href="structrlm__rest__section__t.html#a11db55f380581de8b3d0ff9d018a594d">private_key_password</a>);
<a name="l02060"></a>02060                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02061"></a>02061         }
<a name="l02062"></a>02062         
<a name="l02063"></a>02063         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#ad08faa3621a5dc0d066a098aab8703ce">ca_file</a>) {
<a name="l02064"></a>02064                 ret = curl_easy_setopt(candle,
<a name="l02065"></a>02065                                        CURLOPT_ISSUERCERT,
<a name="l02066"></a>02066                                        section-&gt;<a class="code" href="structrlm__rest__section__t.html#ad08faa3621a5dc0d066a098aab8703ce">ca_file</a>);
<a name="l02067"></a>02067                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02068"></a>02068         }
<a name="l02069"></a>02069         
<a name="l02070"></a>02070         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a2607252990462fef4acf56846edffcbf">ca_path</a>) {
<a name="l02071"></a>02071                 ret = curl_easy_setopt(candle,
<a name="l02072"></a>02072                                        CURLOPT_CAPATH,
<a name="l02073"></a>02073                                        section-&gt;<a class="code" href="structrlm__rest__section__t.html#a2607252990462fef4acf56846edffcbf">ca_path</a>);
<a name="l02074"></a>02074                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02075"></a>02075         }
<a name="l02076"></a>02076         
<a name="l02077"></a>02077         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#ad3c4cd803ab025fb621847ea61d3829e">random_file</a>) {
<a name="l02078"></a>02078                 ret = curl_easy_setopt(candle,
<a name="l02079"></a>02079                                        CURLOPT_RANDOM_FILE,
<a name="l02080"></a>02080                                        section-&gt;<a class="code" href="structrlm__rest__section__t.html#ad3c4cd803ab025fb621847ea61d3829e">random_file</a>);
<a name="l02081"></a>02081                 <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02082"></a>02082         }
<a name="l02083"></a>02083         
<a name="l02084"></a>02084         ret = curl_easy_setopt(candle,
<a name="l02085"></a>02085                                CURLOPT_SSL_VERIFYHOST,
<a name="l02086"></a>02086                                (section-&gt;<a class="code" href="structrlm__rest__section__t.html#ae35764bfef5e3f358e2eb7a42161f745">check_cert_cn</a> == <a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>) ?
<a name="l02087"></a>02087                                 2 : 0);
<a name="l02088"></a>02088         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02089"></a>02089                 
<a name="l02090"></a>02090         <span class="comment">/*</span>
<a name="l02091"></a>02091 <span class="comment">         *      Tell CURL how to get HTTP body content, and how to process</span>
<a name="l02092"></a>02092 <span class="comment">         *      incoming data.</span>
<a name="l02093"></a>02093 <span class="comment">         */</span>
<a name="l02094"></a>02094         <a class="code" href="rest_8c.html#a1d7816f2d318565786021817aeba101f" title="(Re-)Initialises the data in a rlm_rest_write_t.">rest_write_ctx_init</a>(request, &amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>, type);
<a name="l02095"></a>02095 
<a name="l02096"></a>02096         ret = curl_easy_setopt(candle, CURLOPT_HEADERFUNCTION,
<a name="l02097"></a>02097                                <a class="code" href="rest_8c.html#a88deee0c267cfc5af2ce96265faf2fa8" title="Processes incoming HTTP header data from libcurl.">rest_write_header</a>);
<a name="l02098"></a>02098         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02099"></a>02099 
<a name="l02100"></a>02100         ret = curl_easy_setopt(candle, CURLOPT_HEADERDATA,
<a name="l02101"></a>02101                                &amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>);
<a name="l02102"></a>02102         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02103"></a>02103 
<a name="l02104"></a>02104         ret = curl_easy_setopt(candle, CURLOPT_WRITEFUNCTION,
<a name="l02105"></a>02105                                <a class="code" href="rest_8c.html#ad31b21480350ba053bfdb924b54432b5" title="Processes incoming HTTP body data from libcurl.">rest_write_body</a>);
<a name="l02106"></a>02106         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02107"></a>02107 
<a name="l02108"></a>02108         ret = curl_easy_setopt(candle, CURLOPT_WRITEDATA,
<a name="l02109"></a>02109                                &amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>);
<a name="l02110"></a>02110         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02111"></a>02111 
<a name="l02112"></a>02112         <span class="keywordflow">switch</span> (method)
<a name="l02113"></a>02113         {
<a name="l02114"></a>02114                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a90754abc55dbb76862fa50abee5af659">HTTP_METHOD_GET</a> :
<a name="l02115"></a>02115                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a761371f7807255b7912afbac2f665ffe">HTTP_METHOD_DELETE</a> :
<a name="l02116"></a>02116                         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02117"></a>02117                         <span class="keywordflow">break</span>;
<a name="l02118"></a>02118 
<a name="l02119"></a>02119                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2a1944682922ac79b2e682312d8f3f71e2">HTTP_METHOD_POST</a> :
<a name="l02120"></a>02120                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2af7557927b605c64f35f629b43823b1c9">HTTP_METHOD_PUT</a> :
<a name="l02121"></a>02121                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a2fd930fba66817097e73ba9b75800eb2aa0ffdbe653c13c2595d290fb2b651db9">HTTP_METHOD_CUSTOM</a> :
<a name="l02122"></a>02122                         <span class="keywordflow">if</span> (section-&gt;<a class="code" href="structrlm__rest__section__t.html#a9943c22f70d6c45536915bc490c9be56">chunk</a> &gt; 0) {
<a name="l02123"></a>02123                                 ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a30545c830b99de10dc8f2666cf3db8e5">read</a>.<a class="code" href="structrlm__rest__read__t.html#a0e1a10486d8fafdaef68557257524977">chunk</a> = section-&gt;<a class="code" href="structrlm__rest__section__t.html#a9943c22f70d6c45536915bc490c9be56">chunk</a>;
<a name="l02124"></a>02124 
<a name="l02125"></a>02125                                 ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> = curl_slist_append(ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>,
<a name="l02126"></a>02126                                                                  <span class="stringliteral">&quot;Expect:&quot;</span>);
<a name="l02127"></a>02127                                 <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>) <span class="keywordflow">goto</span> error_header;
<a name="l02128"></a>02128 
<a name="l02129"></a>02129                                 ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> = curl_slist_append(ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>,
<a name="l02130"></a>02130                                                                  <span class="stringliteral">&quot;Transfer-Encoding: chunked&quot;</span>);
<a name="l02131"></a>02131                                 <span class="keywordflow">if</span> (!ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>) <span class="keywordflow">goto</span> error_header;
<a name="l02132"></a>02132                         }
<a name="l02133"></a>02133 
<a name="l02134"></a>02134                         <span class="keywordflow">switch</span> (type)
<a name="l02135"></a>02135                         {
<a name="l02136"></a>02136                                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a68c03dcf546a3349f7cdca9cfec7cb08">HTTP_BODY_JSON</a>:
<a name="l02137"></a>02137                                         <a class="code" href="rest_8c.html#a2d6e909e03e0aaab912cf82ca19ba0c6" title="(Re-)Initialises the data in a rlm_rest_read_t.">rest_read_ctx_init</a>(request,
<a name="l02138"></a>02138                                                            &amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a30545c830b99de10dc8f2666cf3db8e5">read</a>, 1);
<a name="l02139"></a>02139 
<a name="l02140"></a>02140                                         ret = <a class="code" href="rest_8c.html#a961fe2c1327442f08fd9c491fff5d2a6" title="Configures body specific curlopts.">rest_request_config_body</a>(instance,
<a name="l02141"></a>02141                                                                        section,
<a name="l02142"></a>02142                                                                        handle,
<a name="l02143"></a>02143                                                                        <a class="code" href="rest_8c.html#a3cf8d055c2f101567cf335ad58c2d7e7" title="Encodes VALUE_PAIR linked list in JSON format.">rest_encode_json</a>);
<a name="l02144"></a>02144                                         <span class="keywordflow">if</span> (!ret) <span class="keywordflow">return</span> -1;
<a name="l02145"></a>02145 
<a name="l02146"></a>02146                                         <span class="keywordflow">break</span>;
<a name="l02147"></a>02147 
<a name="l02148"></a>02148                                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ac6a5a8af942393478386105b35dc80d5">HTTP_BODY_POST</a>:
<a name="l02149"></a>02149                                         <a class="code" href="rest_8c.html#a2d6e909e03e0aaab912cf82ca19ba0c6" title="(Re-)Initialises the data in a rlm_rest_read_t.">rest_read_ctx_init</a>(request,
<a name="l02150"></a>02150                                                            &amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a30545c830b99de10dc8f2666cf3db8e5">read</a>, 0);
<a name="l02151"></a>02151 
<a name="l02152"></a>02152                                         ret = <a class="code" href="rest_8c.html#a961fe2c1327442f08fd9c491fff5d2a6" title="Configures body specific curlopts.">rest_request_config_body</a>(instance,
<a name="l02153"></a>02153                                                                        section,
<a name="l02154"></a>02154                                                                        handle,
<a name="l02155"></a>02155                                                                        <a class="code" href="rest_8c.html#ab434441f64355ba1c46cd4ed51e45425" title="Encodes VALUE_PAIR linked list in POST format.">rest_encode_post</a>);
<a name="l02156"></a>02156                                         <span class="keywordflow">if</span> (!ret) <span class="keywordflow">return</span> -1;
<a name="l02157"></a>02157 
<a name="l02158"></a>02158                                         <span class="keywordflow">break</span>;
<a name="l02159"></a>02159 
<a name="l02160"></a>02160                                 <span class="keywordflow">default</span>:
<a name="l02161"></a>02161                                         assert(0);
<a name="l02162"></a>02162                         }
<a name="l02163"></a>02163 
<a name="l02164"></a>02164                         ret = curl_easy_setopt(candle, CURLOPT_HTTPHEADER,
<a name="l02165"></a>02165                                                ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>);
<a name="l02166"></a>02166                         <span class="keywordflow">if</span> (ret != CURLE_OK) <span class="keywordflow">goto</span> error;
<a name="l02167"></a>02167 
<a name="l02168"></a>02168                         <span class="keywordflow">break</span>;
<a name="l02169"></a>02169 
<a name="l02170"></a>02170                 <span class="keywordflow">default</span>:
<a name="l02171"></a>02171                         assert(0);
<a name="l02172"></a>02172         };
<a name="l02173"></a>02173 
<a name="l02174"></a>02174         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02175"></a>02175 
<a name="l02176"></a>02176         error:
<a name="l02177"></a>02177         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed setting curl option: %i - %s&quot;</span>,
<a name="l02178"></a>02178                instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>, ret, curl_easy_strerror(ret));
<a name="l02179"></a>02179         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02180"></a>02180 
<a name="l02181"></a>02181         error_header:
<a name="l02182"></a>02182         <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Failed creating header&quot;</span>,
<a name="l02183"></a>02183                instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l02184"></a>02184         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02185"></a>02185 }
<a name="l02186"></a>02186 
<a name="l02197"></a><a class="code" href="rest_8c.html#a6d395c046112ff5745d535ab31bc64b5">02197</a> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a6d395c046112ff5745d535ab31bc64b5" title="Sends a REST (HTTP) request.">rest_request_perform</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance,
<a name="l02198"></a>02198                          <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section, <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>)
<a name="l02199"></a>02199 {
<a name="l02200"></a>02200         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *randle = <a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>;
<a name="l02201"></a>02201         CURL *candle              = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a>;
<a name="l02202"></a>02202         CURLcode ret;
<a name="l02203"></a>02203 
<a name="l02204"></a>02204         ret = curl_easy_perform(candle);
<a name="l02205"></a>02205         <span class="keywordflow">if</span> (ret != CURLE_OK) {
<a name="l02206"></a>02206                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Request failed: %i - %s&quot;</span>,
<a name="l02207"></a>02207                        instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>, ret, curl_easy_strerror(ret));
<a name="l02208"></a>02208                 <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02209"></a>02209         }
<a name="l02210"></a>02210 
<a name="l02211"></a>02211         <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa8cecfc5c5c054d2875c03e77b7be15d">TRUE</a>;
<a name="l02212"></a>02212 }
<a name="l02213"></a>02213 
<a name="l02226"></a><a class="code" href="rest_8h.html#a7851d0bf044e4a74fdb396e18d940f8d">02226</a> <span class="keywordtype">int</span> <a class="code" href="rest_8c.html#a7851d0bf044e4a74fdb396e18d940f8d" title="Sends the response to the correct decode function.">rest_request_decode</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance, 
<a name="l02227"></a>02227                         <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l02228"></a>02228                         <a class="code" href="structauth__req.html">REQUEST</a> *request, <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>)
<a name="l02229"></a>02229 {
<a name="l02230"></a>02230         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *randle       = <a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>;
<a name="l02231"></a>02231         <a class="code" href="structrlm__rest__curl__context__t.html">rlm_rest_curl_context_t</a> *ctx    = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#af06d12808076ebfa35b04a35c98584bf">ctx</a>;
<a name="l02232"></a>02232 
<a name="l02233"></a>02233         <span class="keywordtype">int</span> ret;
<a name="l02234"></a>02234 
<a name="l02235"></a>02235         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>.<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a> == NULL) {
<a name="l02236"></a>02236                 <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Skipping attribute processing, no body data received&quot;</span>);
<a name="l02237"></a>02237                 <span class="keywordflow">return</span> <a class="code" href="radiusd_8h.html#aa93f0eb578d23995850d61f7d61c55c1">FALSE</a>;
<a name="l02238"></a>02238         }
<a name="l02239"></a>02239 
<a name="l02240"></a>02240         <a class="code" href="radiusd_8h.html#aed6b15ca1d2e42dd188761d120b74532">RDEBUG</a>(<span class="stringliteral">&quot;Processing body&quot;</span>, ret);
<a name="l02241"></a>02241 
<a name="l02242"></a>02242         <span class="keywordflow">switch</span> (ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>.<a class="code" href="structrlm__rest__write__t.html#a59e3d2d65c6a468abb38251d92657028">type</a>)
<a name="l02243"></a>02243         {
<a name="l02244"></a>02244                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ac6a5a8af942393478386105b35dc80d5">HTTP_BODY_POST</a>:
<a name="l02245"></a>02245                         ret = <a class="code" href="rest_8c.html#a8ac753a6a37bc35d8e06f9bfe17e7fdc" title="Converts POST response into VALUE_PAIRs and adds them to the request.">rest_decode_post</a>(instance, section, request,
<a name="l02246"></a>02246                                                handle, ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>.<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a>,
<a name="l02247"></a>02247                                                ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>.<a class="code" href="structrlm__rest__write__t.html#aba9ff1fc10f3ed00f7e256ea8a887aa2">used</a>);
<a name="l02248"></a>02248                         <span class="keywordflow">break</span>;
<a name="l02249"></a>02249 
<a name="l02250"></a>02250                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a68c03dcf546a3349f7cdca9cfec7cb08">HTTP_BODY_JSON</a>:
<a name="l02251"></a>02251                         ret = <a class="code" href="rest_8c.html#a8ad2c9225b5020dc8007e464687fb602" title="Converts JSON response into VALUE_PAIRs and adds them to the request.">rest_decode_json</a>(instance, section, request,
<a name="l02252"></a>02252                                                handle, ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>.<a class="code" href="structrlm__rest__write__t.html#a75310f9ac238b1c5229e4880359ab5d3">buffer</a>,
<a name="l02253"></a>02253                                                ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>.<a class="code" href="structrlm__rest__write__t.html#aba9ff1fc10f3ed00f7e256ea8a887aa2">used</a>);
<a name="l02254"></a>02254                         <span class="keywordflow">break</span>;
<a name="l02255"></a>02255 
<a name="l02256"></a>02256                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43ab099899ce07949ee61322970cff3f453">HTTP_BODY_UNSUPPORTED</a>:
<a name="l02257"></a>02257                 <span class="keywordflow">case</span> <a class="code" href="rest_8h.html#a3eec2e1ce851fda087b08d05cbd96c43a8a3328b9f8f72b0801e0a36769f74cdb">HTTP_BODY_INVALID</a>:
<a name="l02258"></a>02258                         <span class="keywordflow">return</span> -1;
<a name="l02259"></a>02259 
<a name="l02260"></a>02260                 <span class="keywordflow">default</span>:
<a name="l02261"></a>02261                         assert(0);
<a name="l02262"></a>02262         }
<a name="l02263"></a>02263 
<a name="l02264"></a>02264         <span class="keywordflow">return</span> ret;
<a name="l02265"></a>02265 }
<a name="l02266"></a>02266 
<a name="l02280"></a><a class="code" href="rest_8c.html#a7cd8299f0a41eca8b3475c9f0cb1c625">02280</a> <span class="keywordtype">void</span> <a class="code" href="rest_8c.html#a7cd8299f0a41eca8b3475c9f0cb1c625" title="Cleans up after a REST request.">rest_request_cleanup</a>(<a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance,
<a name="l02281"></a>02281                           <a class="code" href="libradius_8h.html#addf5ec070e9499d36b7f2009ce736076">UNUSED</a> <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section, <span class="keywordtype">void</span> *<a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>)
<a name="l02282"></a>02282 {
<a name="l02283"></a>02283         <a class="code" href="structrlm__rest__handle__t.html">rlm_rest_handle_t</a> *randle       = <a class="code" href="tncs__connect_8c.html#a6b889df921fda124be06a946b9414194">handle</a>;
<a name="l02284"></a>02284         <a class="code" href="structrlm__rest__curl__context__t.html">rlm_rest_curl_context_t</a> *ctx    = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#af06d12808076ebfa35b04a35c98584bf">ctx</a>;
<a name="l02285"></a>02285         CURL *candle                    = randle-&gt;<a class="code" href="structrlm__rest__handle__t.html#aebc230b45593ca743e318b05c8b1b760">handle</a>;
<a name="l02286"></a>02286 
<a name="l02287"></a>02287         <span class="comment">/*</span>
<a name="l02288"></a>02288 <span class="comment">         * Clear any previously configured options</span>
<a name="l02289"></a>02289 <span class="comment">         */</span>
<a name="l02290"></a>02290         curl_easy_reset(candle);
<a name="l02291"></a>02291 
<a name="l02292"></a>02292         <span class="comment">/*</span>
<a name="l02293"></a>02293 <span class="comment">         * Free header list</span>
<a name="l02294"></a>02294 <span class="comment">         */</span>
<a name="l02295"></a>02295         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> != NULL) {
<a name="l02296"></a>02296                 curl_slist_free_all(ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a>);
<a name="l02297"></a>02297                 ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a106b09509c2eb5c73e6626ac6ee6a537">headers</a> = NULL;
<a name="l02298"></a>02298         }
<a name="l02299"></a>02299 
<a name="l02300"></a>02300         <span class="comment">/*</span>
<a name="l02301"></a>02301 <span class="comment">         * Free body data (only used if chunking is disabled)</span>
<a name="l02302"></a>02302 <span class="comment">         */</span>
<a name="l02303"></a>02303         <span class="keywordflow">if</span> (ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a24504ea891b3f35c42e37ea9d80fc00c">body</a> != NULL) free(ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a24504ea891b3f35c42e37ea9d80fc00c">body</a>);
<a name="l02304"></a>02304   
<a name="l02305"></a>02305         <span class="comment">/*</span>
<a name="l02306"></a>02306 <span class="comment">         * Free other context info</span>
<a name="l02307"></a>02307 <span class="comment">         */</span>
<a name="l02308"></a>02308         <a class="code" href="rest_8c.html#a88e265303baa86e23e2b95d3f9f2bf45" title="Frees the VALUE_PAIR array created by rest_read_ctx_init.">rest_read_ctx_free</a>(&amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a30545c830b99de10dc8f2666cf3db8e5">read</a>);
<a name="l02309"></a>02309         <a class="code" href="rest_8c.html#a0dd236900db73e09b33522d2a1af54b1" title="Frees the intermediary buffer created by rest_write.">rest_write_free</a>(&amp;ctx-&gt;<a class="code" href="structrlm__rest__curl__context__t.html#a5d07b6c78eafac29bc7c54bf90991715">write</a>);
<a name="l02310"></a>02310 }
<a name="l02311"></a>02311 
<a name="l02321"></a><a class="code" href="rest_8c.html#a243cd41d83240b6e52cf7e170785a1af">02321</a> <span class="keyword">static</span> <span class="keywordtype">size_t</span> <a class="code" href="rest_8c.html#a243cd41d83240b6e52cf7e170785a1af" title="URL encodes a string.">rest_uri_escape</a>(<span class="keywordtype">char</span> *out, <span class="keywordtype">size_t</span> outlen, <span class="keyword">const</span> <span class="keywordtype">char</span> *raw)
<a name="l02322"></a>02322 {
<a name="l02323"></a>02323         <span class="keywordtype">char</span> *escaped;
<a name="l02324"></a>02324 
<a name="l02325"></a>02325         escaped = curl_escape(raw, strlen(raw));
<a name="l02326"></a>02326         <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(out, escaped, outlen);
<a name="l02327"></a>02327         curl_free(escaped);
<a name="l02328"></a>02328 
<a name="l02329"></a>02329         <span class="keywordflow">return</span> strlen(out);
<a name="l02330"></a>02330 }
<a name="l02331"></a>02331 
<a name="l02346"></a><a class="code" href="rest_8h.html#a2762ce07f4a9e3fbd5ed9d5815c42fd4">02346</a> ssize_t <a class="code" href="rest_8c.html#a2762ce07f4a9e3fbd5ed9d5815c42fd4" title="Builds URI; performs XLAT expansions and encoding.">rest_uri_build</a>(<a class="code" href="structrlm__rest__t.html">rlm_rest_t</a> *instance, <a class="code" href="structrlm__rest__section__t.html">rlm_rest_section_t</a> *section,
<a name="l02347"></a>02347                        <a class="code" href="structauth__req.html">REQUEST</a> *request, <span class="keywordtype">char</span> *buffer, <span class="keywordtype">size_t</span> bufsize)
<a name="l02348"></a>02348 {
<a name="l02349"></a>02349         <span class="keyword">const</span> <span class="keywordtype">char</span> *p, *q;
<a name="l02350"></a>02350 
<a name="l02351"></a>02351         <span class="keywordtype">char</span> *out, *scheme;
<a name="l02352"></a>02352         <span class="keyword">const</span> <span class="keywordtype">char</span> *path;
<a name="l02353"></a>02353 
<a name="l02354"></a>02354         <span class="keywordtype">unsigned</span> <span class="keywordtype">short</span> count = 0;
<a name="l02355"></a>02355 
<a name="l02356"></a>02356         <span class="keywordtype">size_t</span> len;
<a name="l02357"></a>02357 
<a name="l02358"></a>02358         p = section-&gt;<a class="code" href="structrlm__rest__section__t.html#ae7638dc4c4c7d24a5c8e62ae2b7f0afc">uri</a>;
<a name="l02359"></a>02359 
<a name="l02360"></a>02360         <span class="keywordflow">while</span> ((q = strchr(p, <span class="charliteral">&#39;/&#39;</span>)) &amp;&amp; (count++ &lt; 3)) p = (q + 1);
<a name="l02361"></a>02361 
<a name="l02362"></a>02362         <span class="keywordflow">if</span> (count != 3) {
<a name="l02363"></a>02363                 <a class="code" href="radiusd_8h.html#a2e5427774801a60f8ffa40493be5800b">radlog</a>(<a class="code" href="radiusd_8h.html#a20994ae9abfb84898f46f5e525831a0e">L_ERR</a>, <span class="stringliteral">&quot;rlm_rest (%s): Error URI is malformed,&quot;</span>
<a name="l02364"></a>02364                        <span class="stringliteral">&quot; can&#39;t find start of path&quot;</span>, instance-&gt;<a class="code" href="structrlm__rest__t.html#aed02e14e312e94ca24468e4f7058df23">xlat_name</a>);
<a name="l02365"></a>02365                 <span class="keywordflow">return</span> -1;
<a name="l02366"></a>02366         }
<a name="l02367"></a>02367 
<a name="l02368"></a>02368         len = (q - p);
<a name="l02369"></a>02369 
<a name="l02370"></a>02370         scheme = <a class="code" href="radiusd_8h.html#aa6b2f20d83c5a77ba8961dc2aaa365fe">rad_malloc</a>(len + 1);
<a name="l02371"></a>02371         <a class="code" href="missing_8h.html#aeb79f86261de904967d433c1b5e9a1de">strlcpy</a>(scheme, section-&gt;<a class="code" href="structrlm__rest__section__t.html#ae7638dc4c4c7d24a5c8e62ae2b7f0afc">uri</a>, len + 1);
<a name="l02372"></a>02372 
<a name="l02373"></a>02373         path = (q + 1);
<a name="l02374"></a>02374 
<a name="l02375"></a>02375         out = buffer;
<a name="l02376"></a>02376         out += <a class="code" href="radiusd_8h.html#ac68b6c0454e5fdc86f5402299da73091" title="Replace whatever in a string.">radius_xlat</a>(out, bufsize, scheme, request, NULL, NULL);
<a name="l02377"></a>02377 
<a name="l02378"></a>02378         free(scheme);
<a name="l02379"></a>02379 
<a name="l02380"></a>02380         out += <a class="code" href="radiusd_8h.html#ac68b6c0454e5fdc86f5402299da73091" title="Replace whatever in a string.">radius_xlat</a>(out, (bufsize - (buffer - out)), path, request,
<a name="l02381"></a>02381                          <a class="code" href="rest_8c.html#a243cd41d83240b6e52cf7e170785a1af" title="URL encodes a string.">rest_uri_escape</a>, NULL);
<a name="l02382"></a>02382 
<a name="l02383"></a>02383         <span class="keywordflow">return</span> (buffer - out);
<a name="l02384"></a>02384 }
</pre></div></div>
</div>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Files</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(3)"><span class="SelectionMark">&#160;</span>Functions</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(4)"><span class="SelectionMark">&#160;</span>Variables</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(5)"><span class="SelectionMark">&#160;</span>Typedefs</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(6)"><span class="SelectionMark">&#160;</span>Enumerations</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(7)"><span class="SelectionMark">&#160;</span>Enumerator</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(8)"><span class="SelectionMark">&#160;</span>Defines</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>



<hr class="footer"/><address class="footer"><small>
Generated on Fri Oct 5 2012 16:31:04 for FreeRADIUS by &#160;<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/>
</a> 1.7.5
</small></address>

</body>
</html>
